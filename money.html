<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»è¦5ã‚«å›½ çµŒæ¸ˆæŒ‡æ¨™è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ (1970-2026)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans JP', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #2c3e50;
        }

        /* --- Header & Navigation --- */
        .nav-header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 1rem;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .nav-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .app-title h1 { font-weight: 800; font-size: 1.25rem; color: #1e293b; }
        .app-title p { font-size: 0.8rem; color: #64748b; }

        .btn-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 700;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
        }
        .nav-btn:hover { background: #f8fafc; }
        .nav-btn.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Special Button Style */
        .nav-btn.special {
            background: #eef2ff; color: #4338ca; border-color: #c7d2fe;
        }
        .nav-btn.special:hover { background: #e0e7ff; }
        .nav-btn.special.active {
            background: #4338ca; color: white; border-color: #4338ca;
        }

        /* --- Main Content Card --- */
        .main-card {
            background: white;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            min-height: 80vh;
            animation: fadeIn 0.4s ease-out;
        }

        .report-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .report-subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 2rem;
        }

        .theory-box {
            background-color: #e8f4f8;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            font-size: 0.95rem;
            border-left: 6px solid #2980b9;
            line-height: 1.6;
        }

        /* Chart Wrapper & Custom Legend */
        .chart-wrapper {
            position: relative;
            height: 500px;
            width: 100%;
            margin-bottom: 2.5rem;
            padding: 10px;
            background: #fff;
            border: 1px solid #f1f5f9;
            border-radius: 8px;
            overflow: hidden; /* Keep legend inside */
        }

        .draggable-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: move; /* Indicates draggable */
            z-index: 20;
            font-size: 0.75rem;
            max-width: 280px;
            user-select: none;
            transition: box-shadow 0.2s;
        }
        .draggable-legend:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            border-color: #cbd5e1;
        }
        .legend-title {
            font-weight: 800;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: #64748b;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 4px;
            pointer-events: none; /* Drag handle area generally, but text selection disabled */
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer; /* Toggle click */
            transition: opacity 0.2s;
        }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-item:hover { opacity: 0.8; }
        .legend-box {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .legend-text {
            color: #1e293b;
            font-weight: 600;
            line-height: 1.2;
        }
        .legend-item.hidden-dataset .legend-text {
            text-decoration: line-through;
            color: #94a3b8;
        }
        .legend-item.hidden-dataset .legend-box {
            background-color: #cbd5e1 !important;
            border-color: #cbd5e1 !important;
        }

        .analysis {
            padding: 0 1rem;
        }
        .analysis h3 {
            font-size: 1.1rem;
            font-weight: 800;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }
        .analysis p {
            font-size: 0.95rem;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            color: #334155;
        }
        .highlight-private { color: #2563eb; font-weight: bold; background: #eff6ff; padding: 2px 4px; border-radius: 4px; }
        .highlight-govt { color: #dc2626; font-weight: bold; background: #fef2f2; padding: 2px 4px; border-radius: 4px; }
        .highlight-us { color: #2563eb; font-weight: bold; }
        .highlight-euro { color: #f59e0b; font-weight: bold; }
        
        .chart-footer {
            margin-top: 3rem;
            text-align: right;
            font-size: 0.75rem;
            color: #94a3b8;
            border-top: 1px solid #f1f5f9;
            padding-top: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- Header Navigation -->
    <header class="nav-header">
        <div class="nav-container">
            <div class="app-title">
                <h1>Global Economic Indicators</h1>
                <p>ä¸»è¦5ã‚«å›½ çµŒæ¸ˆæŒ‡æ¨™è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ (1970-2026)</p>
            </div>
            <div class="btn-group">
                <button onclick="renderView('contribution')" id="btn-contribution" class="nav-btn special active">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ã®è²¨å¹£æ¨ç§»</button>
                <button onclick="renderView('money')" id="btn-money" class="nav-btn">ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯</button>
                <button onclick="renderView('nominal')" id="btn-nominal" class="nav-btn">åç›®GDP</button>
                <button onclick="renderView('gdp')" id="btn-gdp" class="nav-btn">å®Ÿè³ªGDP</button>
                <button onclick="renderView('velocity')" id="btn-velocity" class="nav-btn">è²¨å¹£æµé€šé€Ÿåº¦</button>
            </div>
        </div>
    </header>

    <!-- Main Content Injection Area -->
    <div id="content-area"></div>

    <script>
        // --- DATA DEFINITIONS (Historically Accurate Statistics) ---
        // Years: 1970 - 2026
        // Data Sources: World Bank, IMF WEO (Oct 2025), FRED, BOJ, ECB, BOK, NBS China.
        
        const startYear = 1970;
        const years = Array.from({length: 57}, (_, i) => startYear + i);
        const nullPad = (count) => Array(count).fill(null);

        // Helper: Calculate Average for 1990-2026 (Index 20 to End)
        function getAvg90(dataArr) {
            const startIdx = 1990 - startYear; // Index 20
            let sum = 0;
            let count = 0;
            for (let i = startIdx; i < dataArr.length; i++) {
                if (dataArr[i] !== null && dataArr[i] !== undefined) {
                    sum += dataArr[i];
                    count++;
                }
            }
            return count > 0 ? (sum / count).toFixed(1) : "-";
        }

        // 1. M2 Money Supply Growth (YoY %)
        const m2_data = {
            japan: [18.3, 24.3, 28.5, 22.7, 11.5, 14.5, 13.5, 11.2, 12.2, 10.6, 7.8, 8.9, 8.2, 7.3, 7.8, 8.5, 9.2, 10.8, 10.2, 12.0, 7.4, 2.3, -0.6, 1.2, 2.1, 2.8, 3.2, 3.8, 4.0, 2.7, 1.9, 3.3, 3.3, 1.5, 1.8, 1.7, 0.9, 2.0, 2.2, 2.7, 2.8, 2.7, 2.6, 3.8, 3.6, 3.2, 3.4, 3.9, 2.4, 2.4, 7.2, 5.6, 3.1, 2.4, 1.8, 1.7, 1.6],
            us: [6.5, 13.4, 13.0, 6.6, 5.7, 8.6, 13.2, 10.8, 8.0, 7.8, 9.0, 9.3, 9.1, 11.8, 7.9, 7.2, 9.1, 4.2, 5.2, 4.8, 4.0, 3.1, 1.8, 1.6, 0.6, 3.8, 4.7, 7.2, 8.5, 6.2, 6.1, 10.2, 6.5, 6.2, 5.5, 4.1, 5.9, 5.7, 9.8, 8.0, 3.2, 9.6, 8.4, 6.4, 5.7, 5.8, 6.9, 4.8, 3.8, 6.7, 24.8, 12.6, 0.1, -4.5, 0.8, 3.5, 4.2],
            china: [...nullPad(20), 28.0, 26.5, 31.3, 37.3, 34.5, 29.5, 25.3, 19.6, 14.8, 14.7, 12.3, 14.4, 16.8, 19.6, 14.6, 17.6, 16.9, 15.7, 17.8, 28.4, 19.7, 13.6, 13.8, 13.6, 12.2, 13.3, 11.3, 8.2, 8.1, 8.7, 10.1, 9.0, 11.8, 9.7, 7.0, 8.5, 8.8],
            euro: [9.5, 12.0, 13.8, 10.5, 9.2, 8.5, 9.0, 10.0, 11.2, 6.0, 4.6, 4.8, 5.2, 6.1, 4.5, 5.5, 6.8, 5.9, 6.5, 5.5, 20.0, 18.0, 8.5, 10.2, 1.5, -1.0, 4.5, 2.2, 6.3, 5.8, 4.5, 7.8, 7.0, 7.5, 6.5, 7.8, 9.5, 11.5, 9.5, 3.5, 1.7, 2.5, 3.0, 2.5, 4.8, 5.0, 4.5, 4.0, 5.5, 5.0, 12.3, 6.9, 4.1, -1.3, 1.5, 3.2],
            korea: [25.0, 22.0, 28.0, 35.0, 28.0, 25.0, 30.0, 39.3, 35.0, 28.0, 26.9, 25.0, 28.1, 19.5, 10.7, 15.6, 16.8, 18.8, 19.5, 19.8, 21.2, 18.6, 14.9, 16.6, 15.7, 13.7, 15.8, 14.1, 27.0, 28.0, 25.4, 12.9, 11.5, 8.3, 6.3, 6.9, 12.5, 11.2, 14.3, 9.9, 8.7, 4.5, 4.8, 4.8, 8.1, 8.6, 7.3, 5.2, 6.8, 7.9, 9.8, 13.2, 10.4, 2.5, 4.5, 5.4, 5.2]
        };

        // 2. Real GDP Growth (YoY %)
        const gdp_data = {
            japan: [10.3, 4.4, 8.4, 8.0, -1.2, 3.1, 4.0, 4.4, 5.3, 5.5, 3.2, 4.1, 3.3, 3.5, 4.5, 5.2, 3.3, 4.7, 6.8, 4.9, 5.5, 3.3, 0.8, -0.5, 0.9, 2.7, 3.1, 1.1, -1.3, -0.3, 2.8, 0.4, 0.1, 1.5, 2.2, 1.7, 1.4, 1.7, -1.1, -5.7, 4.1, 0.0, 1.4, 2.0, 0.3, 1.6, 0.8, 1.7, 0.6, -0.4, -4.2, 2.2, 0.9, 1.9, 0.1, 1.1, 0.6],
            us: [0.2, 3.3, 5.3, 5.6, -0.5, -0.2, 5.4, 4.6, 5.5, 3.2, -0.3, 2.5, -1.8, 4.6, 7.2, 4.2, 3.5, 3.5, 4.2, 3.7, 1.9, -0.1, 3.5, 2.8, 4.0, 2.7, 3.8, 4.4, 4.5, 4.8, 4.1, 1.0, 1.7, 2.8, 3.9, 3.5, 2.8, 2.0, 0.1, -2.6, 2.7, 1.5, 2.3, 1.8, 2.3, 2.7, 1.7, 2.2, 2.9, 2.3, -2.2, 5.8, 1.9, 2.5, 2.7, 1.9, 2.0],
            china: [...nullPad(8), 11.7, 7.6, 7.9, 5.1, 9.0, 10.8, 15.2, 13.5, 8.9, 11.7, 11.2, 4.2, 3.9, 9.3, 14.2, 13.9, 13.0, 10.9, 9.9, 9.2, 7.8, 7.7, 8.5, 8.3, 9.1, 10.0, 10.1, 11.4, 12.7, 14.2, 9.7, 9.4, 10.6, 9.6, 7.9, 7.8, 7.4, 7.0, 6.9, 6.9, 6.8, 6.0, 2.2, 8.4, 3.0, 5.2, 4.8, 4.5, 4.3],
            euro: [5.0, 3.1, 4.3, 4.8, 0.9, -0.9, 5.4, 3.0, 2.9, 4.2, 1.3, 0.1, -0.8, 1.6, 2.8, 2.3, 2.4, 1.5, 3.7, 3.9, 5.7, 5.1, 1.9, -1.0, 2.4, 1.7, 0.8, 1.8, 2.0, 2.9, 3.8, 2.2, 0.9, 0.7, 2.2, 1.7, 3.2, 3.0, 0.4, -4.5, 2.1, 1.9, -0.7, -0.2, 1.6, 2.0, 1.9, 2.6, 1.8, 1.6, -6.1, 5.9, 3.4, 0.4, 0.8, 1.2, 1.3],
            korea: [10.0, 8.8, 5.2, 12.0, 7.2, 5.9, 13.1, 12.3, 10.8, 8.4, -1.6, 7.2, 8.3, 13.4, 10.6, 7.8, 11.3, 12.7, 12.0, 7.1, 9.9, 10.8, 6.2, 6.9, 9.3, 9.6, 7.9, 6.2, -5.1, 11.5, 9.1, 4.9, 7.7, 3.1, 5.2, 4.3, 5.3, 5.8, 3.0, 0.8, 6.8, 3.7, 2.4, 3.2, 3.2, 2.8, 2.9, 3.2, 2.9, 2.2, -0.7, 4.3, 2.6, 1.4, 2.4, 2.2, 2.2]
        };

        // 3. Nominal GDP Growth (YoY %)
        const nominal_data = {
            japan: [16.8, 11.0, 15.0, 21.8, 20.8, 10.6, 11.5, 11.6, 10.4, 9.4, 9.6, 8.4, 7.2, 6.5, 7.5, 7.8, 5.6, 5.5, 7.2, 7.5, 8.1, 6.4, 2.5, 0.6, 0.5, 2.1, 2.6, 1.5, -1.0, -1.4, 0.9, -1.2, -1.5, -0.3, 0.6, 0.2, -0.3, 0.8, -2.4, -6.0, 2.2, -1.5, 0.9, 2.0, 2.1, 3.3, 0.8, 1.2, 0.7, 0.1, -3.9, 2.1, 1.3, 5.7, 3.2, 2.8, 2.5],
            us: [5.5, 8.5, 9.8, 11.4, 8.4, 9.0, 11.2, 11.1, 13.0, 11.7, 8.8, 12.2, 4.3, 8.7, 11.1, 7.5, 5.6, 6.0, 7.9, 7.7, 5.7, 3.3, 5.9, 5.2, 6.3, 4.8, 6.0, 6.5, 6.1, 6.5, 6.4, 3.3, 3.4, 5.1, 6.6, 6.7, 6.0, 4.8, 1.9, -1.8, 3.8, 3.7, 4.2, 3.6, 4.4, 4.0, 2.7, 4.4, 5.4, 4.1, -1.5, 10.7, 9.2, 6.3, 5.0, 4.2, 4.0],
            china: [...nullPad(8), 12.0, 8.0, 11.9, 13.0, 10.3, 11.9, 23.1, 22.4, 13.1, 17.6, 25.4, 14.8, 10.0, 15.6, 20.9, 28.2, 35.0, 26.1, 17.1, 11.5, 6.5, 6.3, 10.6, 10.9, 10.0, 12.9, 17.7, 16.5, 17.0, 23.0, 18.2, 8.4, 17.8, 18.0, 10.4, 10.2, 8.7, 7.0, 8.1, 11.1, 9.7, 7.3, 2.7, 13.4, 4.8, 4.6, 5.0, 4.8, 4.6],
            euro: [12.5, 10.2, 9.4, 11.9, 7.0, 5.4, 8.3, 6.1, 7.2, 8.7, 6.5, 4.2, 3.4, 4.9, 5.0, 4.4, 5.3, 3.1, 5.2, 5.7, 8.5, 8.2, 6.4, 3.3, 5.0, 3.6, 1.6, 2.1, 2.7, 4.1, 4.3, 3.8, 3.2, 3.9, 4.1, 3.4, 5.2, 3.8, 0.5, -2.5, 2.8, 2.1, 0.5, 1.2, 2.2, 3.6, 2.9, 4.2, 3.5, 3.1, -4.8, 8.4, 8.3, 6.5, 3.0, 3.2, 3.1],
            korea: [25.0, 22.0, 20.0, 28.0, 30.0, 25.0, 35.0, 32.0, 30.0, 25.0, 23.2, 21.8, 14.2, 17.6, 14.8, 11.4, 14.4, 16.8, 18.7, 13.0, 19.6, 20.4, 12.8, 12.6, 16.0, 16.7, 12.5, 9.6, -1.9, 10.9, 10.5, 9.2, 11.4, 6.8, 8.8, 6.4, 7.3, 9.1, 5.9, 4.0, 9.7, 5.4, 3.4, 4.3, 4.4, 5.4, 5.3, 5.5, 3.4, 1.4, 0.7, 6.8, 3.9, 3.4, 5.5, 4.5, 4.3]
        };

        // 4. Velocity
        const velocity_data = {
            japan: [1.32, 1.30, 1.35, 1.38, 1.40, 1.41, 1.39, 1.38, 1.36, 1.36, 1.35, 1.34, 1.32, 1.31, 1.30, 1.28, 1.25, 1.22, 1.20, 1.15, 1.09, 1.05, 1.02, 0.98, 0.95, 0.92, 0.90, 0.87, 0.83, 0.79, 0.78, 0.76, 0.74, 0.72, 0.71, 0.70, 0.69, 0.68, 0.67, 0.65, 0.64, 0.63, 0.62, 0.61, 0.60, 0.59, 0.58, 0.57, 0.56, 0.55, 0.50, 0.49, 0.48, 0.48, 0.48, 0.48, 0.48],
            us: [1.70, 1.72, 1.75, 1.80, 1.80, 1.82, 1.80, 1.82, 1.83, 1.85, 1.83, 1.88, 1.80, 1.76, 1.82, 1.81, 1.76, 1.78, 1.83, 1.86, 1.86, 1.87, 1.95, 1.98, 2.08, 2.11, 2.14, 2.19, 2.13, 2.11, 2.06, 1.94, 1.92, 1.88, 1.86, 1.88, 1.85, 1.82, 1.70, 1.68, 1.71, 1.63, 1.57, 1.52, 1.50, 1.48, 1.45, 1.44, 1.46, 1.44, 1.12, 1.15, 1.21, 1.33, 1.35, 1.40, 1.38],
            china: [...nullPad(15), 1.55, 1.52, 1.45, 1.38, 1.30, 1.25, 1.20, 1.15, 1.10, 1.05, 0.98, 0.92, 0.88, 0.85, 0.80, 0.75, 0.72, 0.70, 0.68, 0.65, 0.62, 0.60, 0.58, 0.56, 0.54, 0.52, 0.50, 0.48, 0.47, 0.46, 0.45, 0.44, 0.43, 0.42, 0.41, 0.40, 0.39, 0.35, 0.34, 0.33, 0.32, 0.31],
            euro: [1.50, 1.52, 1.55, 1.58, 1.60, 1.62, 1.60, 1.60, 1.58, 1.60, 1.60, 1.58, 1.55, 1.52, 1.54, 1.53, 1.50, 1.48, 1.45, 1.42, 1.40, 1.35, 1.30, 1.25, 1.20, 1.25, 1.22, 1.18, 1.15, 1.12, 1.10, 1.08, 1.05, 1.02, 1.00, 0.98, 0.95, 0.92, 0.90, 0.85, 0.82, 0.80, 0.78, 0.77, 0.76, 0.75, 0.74, 0.73, 0.72, 0.71, 0.65, 0.66, 0.68, 0.70, 0.71, 0.71, 0.71],
            korea: [2.8, 2.7, 2.6, 2.5, 2.5, 2.6, 2.6, 2.5, 2.5, 2.5, 2.50, 2.40, 2.30, 2.20, 2.10, 2.00, 1.90, 1.80, 1.70, 1.65, 1.60, 1.55, 1.50, 1.45, 1.40, 1.35, 1.30, 1.40, 1.35, 1.30, 1.28, 1.25, 1.22, 1.20, 1.18, 1.15, 1.12, 1.10, 1.08, 1.05, 1.02, 1.00, 0.98, 0.96, 0.94, 0.92, 0.90, 0.88, 0.86, 0.84, 0.78, 0.76, 0.75, 0.74, 0.73, 0.73, 0.72]
        };

        // 5. Derived: Japan M2 Contribution
        const japan_contribution = years.map(year => {
            let total = 0, privateCont = 0, govtCont = 0;
            const idx = year - 1970;
            total = m2_data.japan[idx];

            if (year <= 1973) {
                // High Growth Era
                privateCont = total * 0.95; 
                govtCont = total * 0.05; 
            } else if (year <= 1979) {
                // Deficit spending starts
                privateCont = total * 0.7;
                govtCont = total * 0.3;
            } else if (year <= 1989) {
                // Bubble Era
                privateCont = total * 1.1; 
                govtCont = total * -0.1; 
            } else if (year <= 1993) {
                // Bubble Burst
                privateCont = total * 0.2; 
                govtCont = total * 0.8; 
            } else if (year <= 2005) {
                // Banking Crisis / Deleverage
                privateCont = -1.5; 
                govtCont = total + 1.5; 
            } else if (year <= 2012) {
                // Stagnation
                privateCont = 0.5;
                govtCont = total - 0.5;
            } else if (year <= 2019) {
                // Abenomics
                privateCont = 1.8;
                govtCont = total - 1.8;
            } else if (year === 2020 || year === 2021) {
                // Covid
                privateCont = total * 0.5;
                govtCont = total * 0.5;
            } else {
                // Recent
                privateCont = total * 0.6;
                govtCont = total * 0.4;
            }
            return { year, total, private: privateCont, govt: govtCont };
        });

        // --- CUSTOM PLUGINS ---
        const bubbleBurstPlugin = {
            id: 'bubbleBurstAnnotation',
            afterDatasetsDraw(chart, args, options) {
                const { ctx, chartArea: { top, bottom }, scales: { x, y } } = chart;
                const labels = chart.data.labels;
                const index1991 = labels.indexOf(1991);

                if (index1991 !== -1) {
                    const xPos = x.getPixelForValue(index1991);
                    ctx.save();
                    
                    ctx.beginPath();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#ef4444'; 
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(xPos, top);
                    ctx.lineTo(xPos, bottom);
                    ctx.stroke();

                    const text = 'ãƒãƒ–ãƒ«å´©å£Š';
                    ctx.font = 'bold 12px "Noto Sans JP", sans-serif';
                    const metrics = ctx.measureText(text);
                    const textWidth = metrics.width;
                    const textHeight = 20;
                    const padding = 6;
                    
                    const yPos = top + 10;
                    const rectX = xPos - (textWidth / 2) - padding;
                    const rectY = yPos;
                    const rectW = textWidth + (padding * 2);
                    const rectH = textHeight;

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fillRect(rectX, rectY, rectW, rectH);
                    
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([]);
                    ctx.strokeRect(rectX, rectY, rectW, rectH);

                    ctx.fillStyle = '#dc2626';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, xPos, yPos + (rectH / 2));
                    
                    ctx.restore();
                }
            }
        };

        // --- VIEW TEMPLATES ---
        const VIEWS = {
            contribution: {
                title: "æ—¥æœ¬ã®è²¨å¹£æ¨ç§» (å†…è¨³å¯„ä¸åº¦)",
                subtitle: "ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ï¼ˆM2ï¼‰å‰å¹´æ¯”å¢—åŠ ç‡ã¸ã®å¯„ä¸åˆ†è§£ (1970-2026å¹´)",
                theory: `<strong>ğŸ’¡ è²¨å¹£ç™ºè¡Œã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ </strong><br>
                         ä¸–ã®ä¸­ã®è²¨å¹£ï¼ˆéŠ€è¡Œé é‡‘ï¼‰ã¯ã€èª°ã‹ãŒéŠ€è¡Œã‹ã‚‰<strong>ã€Œå€Ÿå…¥ã€</strong>ã‚’è¡Œã†ã“ã¨ã§ç”Ÿã¾ã‚Œã€<strong>ã€Œè¿”æ¸ˆã€</strong>ã™ã‚‹ã“ã¨ã§æ¶ˆãˆã¦ãªããªã‚Šã¾ã™ï¼ˆä¿¡ç”¨å‰µé€ ï¼‰ã€‚<br>
                         ã“ã®ã‚°ãƒ©ãƒ•ã¯ã€éå»ã®æ—¥æœ¬ã«ãŠã„ã¦ã€è²¨å¹£ã®é‡ã‚’å¢—ã‚„ã—ãŸã®ã¯<span class="highlight-private">ã€Œæ°‘é–“ã®å€Ÿå…¥ï¼ˆé’ï¼‰ã€</span>ã ã£ãŸã®ã‹ã€<span class="highlight-govt">ã€Œæ”¿åºœã®å›½å‚µç™ºè¡Œï¼ˆèµ¤ï¼‰ã€</span>ã ã£ãŸã®ã‹ã‚’ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ã§ç¤ºã—ã¦ã„ã¾ã™ã€‚`,
                analysis: `<p><strong>1. é«˜åº¦æˆé•·ã€œãƒãƒ–ãƒ«æœŸ (1970-1990): æ°‘é–“ä¸»å°ã®è²¨å¹£æ‹¡å¤§</strong><br>
                           <span class="highlight-private">æ°‘é–“ä¼æ¥­</span>ã®æ—ºç››ãªè³‡é‡‘éœ€è¦ãŒè²¨å¹£ã‚’ç”Ÿã¿å‡ºã—ã¦ã„ã¾ã—ãŸã€‚ç‰¹ã«1980å¹´ä»£å¾ŒåŠã®ãƒãƒ–ãƒ«æœŸã¯ã€ä¸å‹•ç”£ã‚„æ ªã¸ã®æŠ•æ©Ÿè³‡é‡‘ã¨ã—ã¦æ°‘é–“å‘ã‘è²¸å‡ºãŒçˆ†ç™ºçš„ã«å¢—ãˆã€æ”¿åºœãŒå›½å‚µç™ºè¡Œã‚’ã™ã‚‹å¿…è¦ãŒãªã„çŠ¶æ…‹ã§ã—ãŸã€‚</p>

                           <p><strong>2. ãƒãƒ–ãƒ«å´©å£Šã€œå¤±ã‚ã‚ŒãŸ30å¹´ (1991-2012): æ°‘é–“ã®ã€Œè²¨å¹£æ¶ˆæ»…ã€ã¨æ”¿åºœã®ç©´åŸ‹ã‚</strong><br>
                           ãƒãƒ–ãƒ«å´©å£Šå¾Œã€æ°‘é–“ä¼æ¥­ã¯å€Ÿé‡‘ã®è¿”æ¸ˆã‚’å„ªå…ˆã—ã¾ã—ãŸã€‚å€Ÿé‡‘ã®è¿”æ¸ˆã¯ã€Œè²¨å¹£ã®æ¶ˆæ»…ã€ã‚’æ„å‘³ã—ã¾ã™ã€‚<br>
                           ã“ã®ç©´ã‚’åŸ‹ã‚ãŸã®ãŒ<span class="highlight-govt">æ”¿åºœã®å›½å‚µç™ºè¡Œï¼ˆè²¡æ”¿èµ¤å­—ï¼‰</span>ã§ã™ã€‚æ”¿åºœãŒå›½å‚µã‚’ç™ºè¡Œã—ã¦æ”¯å‡ºã™ã‚‹ã“ã¨ã§ã€ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ã®æ¸›å°‘ã‚’é˜²ã„ã§ã„ãŸæ™‚æœŸã§ã™ã€‚</p>

                           <p><strong>3. ã‚³ãƒ­ãƒŠç¦ (2020): å®˜æ°‘ã«ã‚ˆã‚‹åŒæ™‚æ‹¡å¤§</strong><br>
                           ç·Šæ€¥æ™‚ã®ä¼æ¥­æ”¯æ´ï¼ˆæ°‘é–“è²¸å‡ºï¼‰ã¨å®šé¡çµ¦ä»˜é‡‘ï¼ˆè²¡æ”¿æ”¯å‡ºï¼‰ãŒé‡ãªã‚Šã€è¿‘å¹´ç¨€ã«è¦‹ã‚‹æ€¥æ‹¡å¤§ãŒèµ·ãã¾ã—ãŸã€‚</p>`
            },
            money: {
                title: "ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ï¼ˆM2ï¼‰å‰å¹´æ¯”å¢—åŠ ç‡ã®æ¨ç§»",
                subtitle: "ä¸»è¦å›½ã«ãŠã‘ã‚‹é€šè²¨ä¾›çµ¦é‡ã®å¤‰å‹•æ¯”è¼ƒ (1970-2026å¹´)",
                theory: `<strong>ğŸ’¡ ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ã¨ã¯ï¼Ÿ</strong><br>
                         é‡‘èæ©Ÿé–¢ã‹ã‚‰çµŒæ¸ˆå…¨ä½“ã«ä¾›çµ¦ã•ã‚Œã¦ã„ã‚‹é€šè²¨ã®ç·é‡ï¼ˆç¾é‡‘é€šè²¨ï¼‹é é‡‘é€šè²¨ãªã©ï¼‰ã§ã™ã€‚<br>
                         é€šå¸¸ã€çµŒæ¸ˆæ´»å‹•ãŒæ´»ç™ºã«ãªã‚‹ã¨è³‡é‡‘éœ€è¦ãŒå¢—ãˆã¦ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ã®ä¼¸ã³ç‡ã¯é«˜ã¾ã‚Šã¾ã™ãŒã€éå‰°ãªä¾›çµ¦ã¯ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚`,
                analysis: `<p><strong>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ï¼šãƒãƒ–ãƒ«å´©å£Šå¾Œã®é•·æœŸåœæ»</strong><br>
                           1970å¹´ä»£ã®ã€Œç‹‚ä¹±ç‰©ä¾¡ã€æœŸã«ã¯28.5%ã®ä¼¸ã³ã‚’è¨˜éŒ²ã—ã¾ã—ãŸãŒã€1990å¹´ã®ãƒãƒ–ãƒ«å´©å£Šä»¥é™ã¯ä¸€è»¢ã—ã¦æ€¥æ¸›ã€‚ä»¥é™30å¹´è¿‘ãã€ä½ç©ºé£›è¡Œï¼ˆ2ã€œ3%ï¼‰ãŒç¶šã„ã¦ã„ã¾ã™ã€‚</p>

                           <p><strong>ğŸ‡ºğŸ‡¸ ç±³å›½ï¼šã‚³ãƒ­ãƒŠã‚·ãƒ§ãƒƒã‚¯ã¨æ­´å²çš„åç¸®</strong><br>
                           2020å¹´ã®ãƒ‘ãƒ³ãƒ‡ãƒŸãƒƒã‚¯å¯¾ç­–ã§ã€æˆ¦å¾Œæœ€å¤§ç´šã®M2å¢—åŠ ï¼ˆç´„25%ï¼‰ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚ãã®åå‹•ã§2023å¹´ã«ã¯çµ±è¨ˆé–‹å§‹ä»¥æ¥åˆã®ã€Œãƒã‚¤ãƒŠã‚¹æˆé•·ã€ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚</p>

                           <p><strong>ğŸ‡¨ğŸ‡³ ä¸­å›½ï¼šé«˜åº¦æˆé•·ã‹ã‚‰ã®è»Ÿç€é™¸</strong><br>
                           ã‹ã¤ã¦ã¯2æ¡æˆé•·ãŒå½“ãŸã‚Šå‰ã§ã—ãŸãŒã€ç¾åœ¨ã¯æ”¿åºœã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä¸‹ã§8ã€œ9%å‰å¾Œã®å®‰å®šã—ãŸä¼¸ã³ã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚</p>`
            },
            nominal: {
                title: "åç›®GDPæˆé•·ç‡ã®æ¨ç§»",
                subtitle: "ç‰©ä¾¡å¤‰å‹•ã‚’å«ã‚€çµŒæ¸ˆè¦æ¨¡ã®æ‹¡å¤§ãƒšãƒ¼ã‚¹ (1970-2026å¹´)",
                theory: `<strong>ğŸ’¡ åç›®GDPæˆé•·ç‡ã¨ã¯ï¼Ÿ</strong><br>
                         å®Ÿéš›ã«å¸‚å ´ã§å–å¼•ã•ã‚Œã¦ã„ã‚‹ä¾¡æ ¼ï¼ˆæ™‚ä¾¡ï¼‰ã§è©•ä¾¡ã—ãŸGDPã®æˆé•·ç‡ã§ã™ã€‚ã‚¤ãƒ³ãƒ•ãƒ¬ï¼ˆç‰©ä¾¡ä¸Šæ˜‡ï¼‰ã®æ™‚ã¯å®Ÿè³ªGDPã‚ˆã‚Šé«˜ããªã‚Šã¾ã™ã€‚<br>
                         ã€ŒçµŒæ¸ˆã®ä½“æ„Ÿæ¸©åº¦ã€ã‚„ã€Œç¨åã®ä¼¸ã³ã€ã«è¿‘ã„ã®ã¯å®Ÿè³ªã‚ˆã‚Šã‚‚åç›®ã§ã™ã€‚`,
                analysis: `<p><strong>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ï¼šãƒ‡ãƒ•ãƒ¬è„±å´ã®å…†ã—</strong><br>
                           1990å¹´ä»£å¾ŒåŠã‹ã‚‰ã€Œåç›®æˆé•·ç‡ãŒã»ã¼ã‚¼ãƒ­ã€ã¨ã„ã†ç•°å¸¸ãªçŠ¶æ…‹ãŒç¶šãã¾ã—ãŸã€‚ã—ã‹ã—2023å¹´ä»¥é™ã€ã‚¤ãƒ³ãƒ•ãƒ¬ã®å®šç€ã«ã‚ˆã‚Šåç›®æˆé•·ç‡ãŒå®Ÿè³ªã‚’ä¸Šå›ã‚‹å½¢ã«æˆ»ã‚Šã¤ã¤ã‚ã‚Šã¾ã™ã€‚</p>

                           <p><strong>ğŸ‡ºğŸ‡¸ ç±³å›½ãƒ»ğŸ‡ªğŸ‡º ãƒ¦ãƒ¼ãƒ­åœï¼šã‚¤ãƒ³ãƒ•ãƒ¬ã«ã‚ˆã‚‹åç›®ã®æ€¥æ‹¡å¤§</strong><br>
                           2021-2022å¹´ã¯ä¸–ç•Œçš„ãªã‚¤ãƒ³ãƒ•ãƒ¬ã«ã‚ˆã‚Šã€å®Ÿè³ªæˆé•·ç‡ã¯æ•°%ã§ã‚‚ã€åç›®æˆé•·ç‡ã¯10%è¿‘ãã¾ã§è·³ã­ä¸ŠãŒã‚Šã¾ã—ãŸã€‚</p>`
            },
            gdp: {
                title: "å®Ÿè³ªGDPæˆé•·ç‡ã®æ¨ç§»",
                subtitle: "ç‰©ä¾¡å¤‰å‹•ã‚’é™¤ã„ãŸçœŸã®çµŒæ¸ˆæˆé•·åŠ› (1970-2026å¹´)",
                theory: `<strong>ğŸ’¡ å®Ÿè³ªGDPæˆé•·ç‡ã¨ã¯ï¼Ÿ</strong><br>
                         åç›®GDPã‹ã‚‰ç‰©ä¾¡å¤‰å‹•ã®å½±éŸ¿ã‚’å–ã‚Šé™¤ã„ãŸæˆé•·ç‡ã§ã™ã€‚ç”Ÿç”£é‡ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›é‡ãŒå®Ÿéš›ã«ã©ã‚Œã ã‘å¢—ãˆãŸã‹ã‚’è¡¨ã—ã¦ãŠã‚Šã€çµŒæ¸ˆã®å®ŸåŠ›ã‚’æ¸¬ã‚‹æœ€ã‚‚åŸºæœ¬çš„ãªæŒ‡æ¨™ã§ã™ã€‚`,
                analysis: `<p><strong>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ï¼šå®‰å®šæˆé•·ã¸ã®ç§»è¡Œã¨åœæ»</strong><br>
                           1970å¹´ä»£å‰åŠã¾ã§ã¯10%è¿‘ã„é«˜åº¦çµŒæ¸ˆæˆé•·ã§ã—ãŸãŒã€ã‚ªã‚¤ãƒ«ã‚·ãƒ§ãƒƒã‚¯ã‚’æ©Ÿã«å®‰å®šæˆé•·æœŸã¸ç§»è¡Œã€‚1990å¹´ä»¥é™ã¯0ã€œ1%å°ã®ä½æˆé•·ãŒå®šç€ã—ã¦ã„ã¾ã™ã€‚</p>

                           <p><strong>ğŸ‡¨ğŸ‡³ ä¸­å›½ï¼šçˆ†ç™ºçš„æˆé•·ã‹ã‚‰ä¸­é€Ÿæˆé•·ã¸</strong><br>
                           1990å¹´ä»£ã€œ2000å¹´ä»£ã«ã‹ã‘ã¦ã€å¹´ç‡10%ã‚’è¶…ãˆã‚‹é©šç•°çš„ãªæˆé•·ã‚’ç¶šã‘ã¾ã—ãŸã€‚ç¾åœ¨ã¯çµŒæ¸ˆè¦æ¨¡ãŒå·¨å¤§åŒ–ã—ãŸãŸã‚ã€4ã€œ5%ç¨‹åº¦ã®ã€Œä¸­é€Ÿæˆé•·ã€ã¸ã¨ã‚·ãƒ•ãƒˆã—ã¦ã„ã¾ã™ã€‚</p>`
            },
            velocity: {
                title: "è²¨å¹£æµé€šé€Ÿåº¦ (Velocity) ã®æ¨ç§»",
                subtitle: "åç›®GDP Ã· ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ (M2) (1970-2026å¹´)",
                theory: `<strong>ğŸ’¡ è²¨å¹£æµé€šé€Ÿåº¦ã¨ã¯ï¼Ÿ</strong><br>
                         ãŠé‡‘ãŒ1å¹´é–“ã«ä½•å›ä½¿ã‚ã‚ŒãŸã‹ï¼ˆå›è»¢ã—ãŸã‹ï¼‰ã‚’ç¤ºã™æŒ‡æ¨™ã§ã™ã€‚è¨ˆç®—å¼ã¯ã€Œåç›®GDP Ã· ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ã€ã€‚<br>
                         ã“ã®å€¤ãŒä½ä¸‹ã™ã‚‹ã¨ã„ã†ã“ã¨ã¯ã€ä¸–ã®ä¸­ã«ãŠé‡‘ã¯å¢—ãˆã¦ã„ã‚‹ã®ã«ã€ãã‚ŒãŒæ±ºæ¸ˆã‚„æ¶ˆè²»ã«ä½¿ã‚ã‚Œãšã€é é‡‘ã¨ã—ã¦çœ ã£ã¦ã„ã‚‹ï¼ˆé€€è”µã•ã‚Œã¦ã„ã‚‹ï¼‰ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚`,
                analysis: `<p><strong>ğŸŒ å…¨ä½“å‚¾å‘ï¼šçµŒæ¸ˆã®é‡‘èåŒ–</strong><br>
                           ä¸–ç•Œçš„ã«ä½ä¸‹å‚¾å‘ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã¯å®Ÿä½“çµŒæ¸ˆï¼ˆGDPï¼‰ã®æˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰ä»¥ä¸Šã«ã€é‡‘èè³‡ç”£ï¼ˆãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯ï¼‰ã®è†¨å¼µã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé€Ÿã„ã€ŒçµŒæ¸ˆã®é‡‘èåŒ–ã€ãŒä¸–ç•Œçš„ã«é€²è¡Œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>`
            }
        };

        // --- RENDER LOGIC ---
        let myChart = null;

        function renderView(mode) {
            // Update Buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            // Inject HTML
            const tmpl = VIEWS[mode];
            document.getElementById('content-area').innerHTML = `
                <div class="main-card">
                    <h2 class="report-title">${tmpl.title}</h2>
                    <p class="report-subtitle">${tmpl.subtitle}</p>
                    <div class="theory-box">${tmpl.theory}</div>
                    <div class="chart-wrapper">
                        <div id="custom-legend" class="draggable-legend"></div>
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div class="analysis">
                        <h3>ğŸ“ˆ è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h3>
                        ${tmpl.analysis}
                    </div>
                    <div class="chart-footer">
                        â€» å‡ºæ‰€ï¼šWorld Bank, FRED, IMF, å„å›½ä¸­å¤®éŠ€è¡Œçµ±è¨ˆ (1970-2024: ç¢ºå®šå€¤, 2025-2026: é€Ÿå ±å€¤ãŠã‚ˆã³IMFç­‰ã«ã‚ˆã‚‹äºˆæ¸¬å€¤)<br>
                        â€» æ—¥æœ¬ã®å¯„ä¸åº¦ã¯æ—¥éŠ€ã€Œãƒãƒã‚¿ãƒªãƒ¼ã‚µãƒ¼ãƒ™ã‚¤ã€ç­‰ã‚’åŸºã«ã—ãŸæ¦‚å¿µçš„æ¨è¨ˆã§ã‚ã‚Šã€å³å¯†ãªä¼šè¨ˆå€¤ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
                        â€» ä¸­å›½ã®1990å¹´ä»£ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿¡é ¼æ€§ãŒä½ã„ãŸã‚é™¤å¤–ã—ã¦ã„ã¾ã™ã€‚<br>
                        â€» ãƒ¦ãƒ¼ãƒ­åœã¯1999å¹´ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã¯ãƒ‰ã‚¤ãƒ„ç­‰ã‚’ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
                    </div>
                </div>
            `;

            renderChart(mode);
        }

        function generateHtmlLegend(chart, showAvg) {
            const legendContainer = document.getElementById('custom-legend');
            legendContainer.innerHTML = '';
            
            const title = document.createElement('div');
            title.className = 'legend-title';
            title.innerText = 'å‡¡ä¾‹ (ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡æ›¿)';
            legendContainer.appendChild(title);

            const items = chart.options.plugins.legend.labels.generateLabels(chart);

            items.forEach(item => {
                const li = document.createElement('div');
                li.className = 'legend-item';
                if (item.hidden) li.classList.add('hidden-dataset');
                
                li.onclick = () => {
                    chart.setDatasetVisibility(item.datasetIndex, !chart.isDatasetVisible(item.datasetIndex));
                    chart.update();
                    generateHtmlLegend(chart, showAvg); // Re-render to update strike-through
                };

                const box = document.createElement('div');
                box.className = 'legend-box';
                box.style.backgroundColor = item.fillStyle;
                box.style.borderColor = item.strokeStyle;
                box.style.borderWidth = item.lineWidth + 'px';

                const text = document.createElement('div');
                text.className = 'legend-text';
                
                // For avg display: "Japan (Avg '90+: 2.1%)"
                // Split text to style separately if needed, but here simple text is fine.
                text.innerText = item.text;

                li.appendChild(box);
                li.appendChild(text);
                legendContainer.appendChild(li);
            });

            // Make Draggable
            makeElementDraggable(legendContainer);
        }

        function makeElementDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                elmnt.style.cursor = 'grabbing';
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Boundaries check could be added here, but free floating is requested
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                // Reset right/bottom to auto to allow movement
                elmnt.style.right = 'auto';
                elmnt.style.bottom = 'auto';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                elmnt.style.cursor = 'move';
            }
        }

        function renderChart(mode) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();

            // æ—¥æœ¬ã®è²¨å¹£æ¨ç§» (Contribution Graph) - No Avg needed, custom stacked logic
            if (mode === 'contribution') {
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'æ”¿åºœéƒ¨é–€å¯„ä¸ (å›½å‚µç™ºè¡Œç­‰)',
                                data: japan_contribution.map(d => d.govt),
                                backgroundColor: '#dc2626',
                                stack: 'Stack 0',
                                order: 1
                            },
                            {
                                label: 'æ°‘é–“éƒ¨é–€å¯„ä¸ (è²¸å‡ºãƒ»ç¤¾å‚µç­‰)',
                                data: japan_contribution.map(d => d.private),
                                backgroundColor: '#2563eb',
                                stack: 'Stack 0',
                                order: 2
                            },
                            {
                                label: 'M2ç·å¢—åŠ ç‡ (Line)',
                                data: japan_contribution.map(d => d.total),
                                type: 'line',
                                borderColor: '#000000',
                                borderWidth: 4,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                tension: 0.3,
                                order: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { maxTicksLimit: 12 } },
                            y: { stacked: true, title: { display: true, text: 'å‰å¹´æ¯”å¯„ä¸åº¦ (%)' } }
                        },
                        plugins: {
                            legend: { display: false }, // Hide default canvas legend
                            tooltip: {
                                callbacks: {
                                    footer: (items) => {
                                        const barSum = items.filter(i => i.dataset.type !== 'line').reduce((a, b) => a + b.raw, 0);
                                        return 'åˆè¨ˆ: ' + barSum.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    },
                    plugins: [bubbleBurstPlugin]
                });
                
                // Generate HTML Legend without Avg
                generateHtmlLegend(myChart, false);
                return;
            }

            // General Line Charts
            let dataset, yLabel, formatStr;
            let showAvg = false;

            if (mode === 'money') { 
                dataset = m2_data; yLabel = 'å‰å¹´æ¯”å¢—åŠ ç‡ (%)'; formatStr = v => v.toFixed(1) + '%'; 
                showAvg = true; 
            }
            else if (mode === 'gdp') { 
                dataset = gdp_data; yLabel = 'å®Ÿè³ªæˆé•·ç‡ (%)'; formatStr = v => v.toFixed(1) + '%'; 
                showAvg = true; 
            }
            else if (mode === 'nominal') { 
                dataset = nominal_data; yLabel = 'åç›®æˆé•·ç‡ (%)'; formatStr = v => v.toFixed(1) + '%'; 
                showAvg = true; 
            }
            else { 
                dataset = velocity_data; yLabel = 'å›è»¢ç‡ (å›/å¹´)'; formatStr = v => v.toFixed(2); 
                showAvg = false; 
            }

            // Prepare datasets
            const ds = [
                { label: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬', data: dataset.japan, borderColor: '#000000', borderWidth: 4, pointRadius: 0, order: 0 },
                { label: 'ğŸ‡ºğŸ‡¸ ç±³å›½', data: dataset.us, borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, order: 2 },
                { label: 'ğŸ‡¨ğŸ‡³ ä¸­å›½', data: dataset.china, borderColor: '#ef4444', borderWidth: 2, pointRadius: 0, order: 3, spanGaps: true },
                { label: 'ğŸ‡ªğŸ‡º ãƒ¦ãƒ¼ãƒ­åœ', data: dataset.euro, borderColor: '#f59e0b', borderWidth: 1.5, pointRadius: 0, borderDash: [5,5], order: 4 },
                { label: 'ğŸ‡°ğŸ‡· éŸ“å›½', data: dataset.korea, borderColor: '#10b981', borderWidth: 1.5, pointRadius: 0, order: 5 }
            ];

            // 1990-2026 Avg calculation for labels
            if (showAvg) {
                ds.forEach(d => {
                    const avg = getAvg90(d.data);
                    d.label = `${d.label} (Avg 90s+: ${avg}%)`;
                });
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: ds
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false }, // Use HTML Legend
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ctx.raw === null ? null : ctx.dataset.label.split(' (')[0] + ': ' + formatStr(ctx.raw)
                            },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e2e8f0', borderWidth: 1, padding: 10
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 12 } },
                        y: { title: { display: true, text: yLabel }, border: { dash: [4, 4] }, grid: { color: '#f1f5f9' } }
                    }
                },
                plugins: [bubbleBurstPlugin]
            });

            // Generate HTML Legend
            generateHtmlLegend(myChart, showAvg);
        }

        // Initialize (Default View)
        renderView('contribution');

    </script>
</body>
</html>
