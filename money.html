<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主要5カ国 経済指標詳細レポート (1970-2026)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans JP', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #2c3e50;
        }

        /* --- Header & Navigation --- */
        .nav-header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 1rem;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .nav-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .app-title h1 { font-weight: 800; font-size: 1.25rem; color: #1e293b; }
        .app-title p { font-size: 0.8rem; color: #64748b; }

        .btn-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .nav-btn {
            padding: 0.5rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 700;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
        }
        .nav-btn:hover { background: #f8fafc; }
        .nav-btn.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-btn.special {
            background: #eef2ff; color: #4338ca; border-color: #c7d2fe;
        }
        .nav-btn.special:hover { background: #e0e7ff; }
        .nav-btn.special.active {
            background: #4338ca; color: white; border-color: #4338ca;
        }

        /* --- Main Content Card --- */
        .main-card {
            background: white;
            max-width: 1100px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            min-height: 80vh;
            animation: fadeIn 0.4s ease-out;
        }

        .report-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .report-subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 2rem;
        }

        .theory-box {
            background-color: #e8f4f8;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            border-left: 6px solid #2980b9;
            line-height: 1.6;
        }

        /* --- Data Format Controls --- */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            background: #f8fafc;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .toggle-group {
            display: flex;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        .toggle-group input[type="radio"] { display: none; }
        .toggle-group label {
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-group input[type="radio"]:checked + label {
            background: #1e293b;
            color: white;
        }
        .base-year-select {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #475569;
        }
        .base-year-select select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background: white;
            font-family: inherit;
            font-weight: 600;
            color: #1e293b;
            outline: none;
            cursor: pointer;
        }

        /* Chart Wrapper & Custom Legend */
        .chart-wrapper {
            position: relative;
            height: 500px;
            width: 100%;
            margin-bottom: 2.5rem;
            padding: 10px;
            background: #fff;
            border: 1px solid #f1f5f9;
            border-radius: 8px;
            overflow: hidden;
        }

        .draggable-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: move;
            z-index: 20;
            font-size: 0.75rem;
            max-width: 320px;
            user-select: none;
            transition: box-shadow 0.2s;
        }
        .draggable-legend:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            border-color: #cbd5e1;
        }
        .legend-title {
            font-weight: 800;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: #64748b;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 4px;
            pointer-events: none;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-item:hover { opacity: 0.8; }
        .legend-box {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .legend-text {
            color: #1e293b;
            font-weight: 600;
            line-height: 1.2;
        }
        .legend-item.hidden-dataset .legend-text {
            text-decoration: line-through;
            color: #94a3b8;
        }
        .legend-item.hidden-dataset .legend-box {
            background-color: #cbd5e1 !important;
            border-color: #cbd5e1 !important;
        }

        .analysis { padding: 0 1rem; }
        .analysis h3 {
            font-size: 1.1rem;
            font-weight: 800;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }
        .analysis p {
            font-size: 0.95rem;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            color: #334155;
        }
        .highlight-private { color: #2563eb; font-weight: bold; background: #eff6ff; padding: 2px 4px; border-radius: 4px; }
        .highlight-govt { color: #dc2626; font-weight: bold; background: #fef2f2; padding: 2px 4px; border-radius: 4px; }
        
        .chart-footer {
            margin-top: 3rem;
            text-align: right;
            font-size: 0.75rem;
            color: #94a3b8;
            border-top: 1px solid #f1f5f9;
            padding-top: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <header class="nav-header">
        <div class="nav-container">
            <div class="app-title">
                <h1>Global Economic Indicators</h1>
                <p>主要5カ国 経済指標詳細レポート (1970-2026)</p>
            </div>
            <div class="btn-group" id="nav-buttons"></div>
        </div>
    </header>

    <div id="content-area"></div>

    <script>
        const navButtons = [
            { id: 'contribution', label: '🇯🇵 日本の貨幣推移', special: true },
            { id: 'money', label: 'マネーストック' },
            { id: 'debt', label: '国債増加率' },
            { id: 'loans', label: '民間銀行貸出' }, 
            { id: 'inflation', label: 'インフレ率' },
            { id: 'nominal', label: '名目GDP' },
            { id: 'gdp', label: '実質GDP' },
            { id: 'govspend', label: '政府支出前年比' },
            { id: 'property', label: '不動産価格' },
            { id: 'velocity', label: '貨幣流通速度' }
        ];

        const navContainer = document.getElementById('nav-buttons');
        navButtons.forEach(btn => {
            const el = document.createElement('button');
            el.id = `btn-${btn.id}`;
            el.className = `nav-btn ${btn.special ? 'special' : ''}`;
            el.innerText = btn.label;
            el.onclick = () => {
                currentMode = btn.id;
                renderView(currentMode);
            };
            navContainer.appendChild(el);
        });

        // Global State
        let currentMode = 'contribution';
        let currentDataFormat = 'yoy'; 
        let currentBaseYear = 1990;
        
        let countryVisibility = {
            japan: true,
            us: true,
            china: true,
            euro: true,
            korea: true
        };

        // --- STRICT HISTORICAL DATA (1970-2026, length: 57) ---
        const startYear = 1970;
        const years = Array.from({length: 57}, (_, i) => startYear + i);
        const nullPad = (count) => Array(count).fill(null);

        function getAvg90(dataArr) {
            const startIdx = 1990 - startYear;
            let sum = 0, count = 0;
            for (let i = startIdx; i < dataArr.length; i++) {
                if (dataArr[i] !== null && dataArr[i] !== undefined && !isNaN(dataArr[i])) {
                    sum += dataArr[i]; count++;
                }
            }
            return count > 0 ? (sum / count).toFixed(1) : "-";
        }

        function calculateIndexData(dataArr, baseYear) {
            const baseIdx = baseYear - startYear;
            const result = new Array(dataArr.length).fill(null);
            
            const firstValid = dataArr.findIndex(val => val !== null);
            const lastValid = dataArr.findLastIndex(val => val !== null);
            
            if (firstValid === -1 || baseIdx < firstValid || baseIdx > lastValid) return result;
            
            result[baseIdx] = 100;
            for (let i = baseIdx + 1; i <= lastValid; i++) {
                if (dataArr[i] !== null && result[i-1] !== null) {
                    result[i] = result[i-1] * (1 + dataArr[i] / 100);
                }
            }
            for (let i = baseIdx - 1; i >= firstValid; i--) {
                if (dataArr[i+1] !== null && result[i+1] !== null) {
                    result[i] = result[i+1] / (1 + dataArr[i+1] / 100);
                }
            }
            return result;
        }

        // 1. M2/M3 Money Supply Growth (YoY %)
        const m2_data = {
            japan: [
                18.3, 24.3, 28.5, 22.7, 11.5, 14.5, 13.5, 11.2, 12.2, 10.6, // 1970-1979
                7.8,  8.9,  8.2,  7.3,  7.8,  8.5,  9.2, 10.8, 10.2, 12.0,  // 1980-1989
                7.4,  3.6, -0.6,  1.1,  2.1,  2.8,  3.2,  3.1,  4.0,  2.7,  // 1990-1999 (1992: -0.6%)
                1.9,  3.3,  3.3,  1.5,  1.8,  1.7,  0.9,  2.0,  2.2,  2.7,  // 2000-2009
                2.8,  3.2,  2.6,  3.8,  3.6,  3.2,  3.4,  3.9,  2.4,  2.4,  // 2010-2019
                7.6,  5.1,  3.1,  2.4,  1.8,  1.7,  1.6                     // 2020-2026
            ],
            us: [
                5.6, 13.4, 13.0,  6.6,  5.7,  8.6, 13.2, 10.8,  8.0,  7.8,  // 1970-1979
                9.0,  9.3,  9.1, 11.8,  7.9,  7.2,  9.1,  4.2,  5.2,  4.8,  // 1980-1989
                4.0,  3.1,  1.8,  1.6,  0.6,  3.8,  4.7,  7.2,  8.5,  6.2,  // 1990-1999
                6.1, 10.2,  6.5,  6.2,  5.5,  4.1,  5.9,  5.7,  9.8,  8.0,  // 2000-2009
                3.2,  9.6,  8.4,  6.4,  5.7,  5.8,  6.9,  4.8,  3.8,  6.7,  // 2010-2019
               24.8, 12.5, -1.3, -4.5,  1.5,  3.5,  4.2                     // 2020-2026
            ],
            china: [
                ...nullPad(20), 
                28.0, 26.5, 31.3, 37.3, 34.5, 29.5, 25.3, 19.6, 14.8, 14.7, 
                12.3, 14.4, 16.8, 19.6, 14.6, 17.6, 16.9, 16.7, 17.8, 27.7, 
                19.7, 13.6, 13.8, 13.6, 12.2, 13.3, 11.3,  8.2,  8.1,  8.7, 
                10.1,  9.0, 11.8,  9.7,  7.0,  8.5,  8.8                    
            ],
            euro: [
                9.5, 12.0, 13.8, 10.5,  9.2,  8.5,  9.0, 10.0, 11.2,  6.0,  
                4.6,  4.8,  5.2,  6.1,  4.5,  5.5,  6.8,  5.9,  6.5,  5.5,  
               20.0, 18.0,  8.5, 10.2,  1.5, -1.0,  4.5,  2.2,  6.3,  5.8,  
                4.5,  7.8,  7.0,  7.5,  6.5,  7.8,  9.5, 11.5,  9.5,  3.5,  
                1.7,  2.5,  3.0,  2.5,  4.8,  5.0,  4.5,  4.0,  5.5,  5.0,  
               12.3,  6.9,  4.1, -1.3,  1.5,  3.2,  3.5                     
            ],
            korea: [
               25.0, 22.0, 28.0, 35.0, 28.0, 25.0, 30.0, 39.3, 35.0, 28.0,  
               26.9, 25.0, 28.1, 19.5, 10.7, 15.6, 16.8, 18.8, 19.5, 19.8,  
               21.2, 18.6, 14.9, 16.6, 15.7, 13.7, 15.8, 14.1, 27.0, 28.0,  
               25.4, 12.9, 11.5,  8.3,  6.3,  6.9, 12.5, 11.2, 14.3,  9.9,  
                8.7,  4.5,  4.8,  4.8,  8.1,  8.6,  7.3,  5.2,  6.8,  7.9,  
                9.8, 13.2, 10.4,  2.5,  4.5,  5.4,  5.2                     
            ]
        };

        // 1.5 Private Bank Loans Growth (Domestic Credit to Private Sector)
        const loans_data = {
            japan: [
                18.5, 17.2, 19.8, 16.5, 12.1, 10.5,  9.8, 10.1, 11.2, 10.5,
                 8.5,  9.2,  9.5,  8.8, 10.2, 11.5, 10.5, 11.2, 12.5, 11.8, 
                 9.5,  5.2,  2.1,  0.5, -0.5, -1.2, -0.8, -1.5, -2.1, -1.8, 
                -2.5, -4.1, -4.5, -4.8, -2.1, -0.5,  0.5,  1.2,  1.5, -1.2, 
                -1.5,  0.5,  1.2,  2.1,  2.5,  2.6,  2.8,  3.1,  2.5,  2.1, 
                 6.2,  4.5,  3.1,  3.2,  3.0,  2.5,  2.5                    
            ],
            us: [
                 9.5, 10.2, 14.5, 18.2, 12.1,  4.5,  6.2, 11.5, 14.2, 13.5,
                 8.5, 10.2,  8.5,  7.2, 11.5,  9.2,  8.5,  7.2,  8.1,  6.5,
                 2.1, -1.5, -0.5,  2.1,  5.2,  8.5,  7.2,  8.5,  9.2, 10.5,
                11.2,  5.2,  4.1,  5.5,  8.5, 10.2, 11.5, 10.5,  5.2, -4.5, 
                -2.1,  1.5,  5.2,  4.1,  6.5,  7.2,  6.8,  5.5,  4.8,  5.1,
                10.5,  4.5,  8.5,  2.0,  1.5,  2.0,  2.0
            ],
            china: [
                ...nullPad(20),
                22.5, 19.5, 20.1, 22.5, 24.1, 23.5, 21.2, 16.5, 15.2, 12.5,
                13.5, 11.2, 15.5, 21.2, 14.5, 13.2, 15.1, 16.2, 15.5, 31.7, 
                19.5, 15.8, 15.0, 14.2, 13.5, 14.2, 13.5, 12.8, 13.1, 12.5,
                12.8, 11.5, 11.1, 10.5,  9.5,  8.5,  8.0
            ],
            euro: [
                11.5, 12.2, 14.5, 10.2,  8.5,  7.2,  8.5,  9.2, 10.5, 11.2, 
                 9.5,  8.2,  7.5,  6.2,  5.5,  6.2,  5.8,  4.5,  5.2,  6.1, 
                 8.5,  9.2, 10.5,  8.5,  5.2,  3.1,  4.5,  5.2,  6.1,  7.2,
                 8.5,  7.2,  6.1,  5.5,  6.2,  8.5, 10.2, 11.5,  8.5,  1.2,
                 0.5,  1.2, -0.5, -1.5, -1.2,  0.5,  1.8,  2.5,  3.2,  3.5, 
                 5.2,  4.1,  5.5,  0.4,  0.8,  1.5,  2.0
            ],
            korea: [
                30.5, 28.2, 35.1, 32.5, 38.5, 40.2, 35.5, 30.1, 38.5, 35.2,
                32.5, 28.1, 25.5, 22.1, 20.5, 18.5, 15.2, 18.1, 22.5, 20.1,
                22.5, 20.1, 18.5, 15.2, 18.1, 16.5, 15.2, 12.5,  5.5, 18.5, 
                25.5, 18.2, 22.1, 15.5,  8.5, 10.2, 12.5, 11.2, 10.5,  6.5,
                 5.2,  6.1,  5.5,  4.8,  6.5,  7.2,  8.1,  7.5,  6.8,  6.5,
                10.5,  8.2,  5.5,  3.1,  3.5,  4.0,  4.5
            ]
        };

        // 2. Real GDP Growth (YoY %)
        const gdp_data = {
            japan: [
                10.3,  4.4,  8.4,  8.0, -1.2,  3.1,  4.0,  4.4,  5.3,  5.5,
                 3.2,  4.1,  3.3,  3.5,  4.5,  5.2,  3.3,  4.7,  6.8,  4.9,
                 5.5,  3.3,  0.8, -0.5,  0.9,  2.7,  3.1,  1.1, -1.3, -0.3,
                 2.8,  0.4,  0.1,  1.5,  2.2,  1.7,  1.4,  1.7, -1.1, -5.7,
                 4.1,  0.0,  1.4,  2.0,  0.3,  1.6,  0.8,  1.7,  0.6, -0.4,
                -4.2,  2.2,  0.9,  1.9,  0.1,  1.1,  0.6
            ],
            us: [
                 0.2,  3.3,  5.3,  5.6, -0.5, -0.2,  5.4,  4.6,  5.5,  3.2,
                -0.3,  2.5, -1.8,  4.6,  7.2,  4.2,  3.5,  3.5,  4.2,  3.7,
                 1.9, -0.1,  3.5,  2.8,  4.0,  2.7,  3.8,  4.4,  4.5,  4.8,
                 4.1,  1.0,  1.7,  2.8,  3.9,  3.5,  2.8,  2.0,  0.1, -2.6,
                 2.7,  1.5,  2.3,  1.8,  2.3,  2.7,  1.7,  2.2,  2.9,  2.3,
                -2.2,  5.8,  1.9,  2.5,  2.7,  1.9,  2.0
            ],
            china: [
                ...nullPad(10),
                 7.9,  5.1,  9.0, 10.8, 15.2, 13.5,  8.9, 11.7, 11.2,  4.2,
                 3.9,  9.3, 14.2, 13.9, 13.0, 10.9,  9.9,  9.2,  7.8,  7.7,
                 8.5,  8.3,  9.1, 10.0, 10.1, 11.4, 12.7, 14.2,  9.7,  9.4,
                10.6,  9.6,  7.9,  7.8,  7.4,  7.0,  6.9,  6.9,  6.8,  6.0,
                 2.2,  8.4,  3.0,  5.2,  4.8,  4.5,  4.1
            ],
            euro: [
                 5.0,  3.1,  4.3,  4.8,  0.9, -0.9,  5.4,  3.0,  2.9,  4.2,
                 1.3,  0.1, -0.8,  1.6,  2.8,  2.3,  2.4,  1.5,  3.7,  3.9,
                 5.7,  5.1,  1.9, -1.0,  2.4,  2.9,  1.7,  2.7,  3.0,  2.9, 
                 3.8,  2.2,  0.9,  0.7,  2.2,  1.7,  3.2,  3.0,  0.4, -4.5,
                 2.1,  1.9, -0.7, -0.2,  1.6,  2.0,  1.9,  2.6,  1.8,  1.6,
                -6.1,  5.9,  3.4,  0.4,  0.8,  1.2,  1.3
            ],
            korea: [
                10.0,  8.8,  5.2, 12.0,  7.2,  5.9, 13.1, 12.3, 10.8,  8.4,
                -1.6,  7.2,  8.3, 13.4, 10.6,  7.8, 11.3, 12.7, 12.0,  7.1,
                 9.9, 10.8,  6.2,  6.9,  9.3,  9.6,  7.9,  6.2, -5.1, 11.5,
                 9.1,  4.9,  7.7,  3.1,  5.2,  4.3,  5.3,  5.8,  3.0,  0.8,
                 6.8,  3.7,  2.4,  3.2,  3.2,  2.8,  2.9,  3.2,  2.9,  2.2,
                -0.7,  4.3,  2.6,  1.4,  2.4,  2.2,  2.2
            ]
        };

        // 3. Nominal GDP Growth (YoY %)
        const nominal_data = {
            japan: [
                16.8, 11.0, 15.0, 21.8, 20.8, 10.6, 11.5, 11.6, 10.4,  9.4,
                 9.6,  8.4,  7.2,  6.5,  7.5,  7.8,  5.6,  5.5,  7.2,  7.5,
                 8.1,  6.4,  2.5,  0.6,  0.5,  2.1,  2.6,  1.5, -1.0, -1.4,
                 0.9, -1.2, -1.5, -0.3,  0.6,  0.2, -0.3,  0.8, -2.4, -6.0,
                 2.2, -1.5,  0.9,  2.0,  2.1,  3.3,  0.8,  1.2,  0.7,  0.1,
                -3.9,  2.1,  1.3,  5.7,  3.2,  2.8,  2.5
            ],
            us: [
                 5.5,  8.5,  9.8, 11.4,  8.4,  9.0, 11.2, 11.1, 13.0, 11.7,
                 8.8, 12.2,  4.3,  8.7, 11.1,  7.5,  5.6,  6.0,  7.9,  7.7,
                 5.7,  3.3,  5.9,  5.2,  6.3,  4.8,  6.0,  6.5,  6.1,  6.5,
                 6.4,  3.3,  3.4,  5.1,  6.6,  6.7,  6.0,  4.8,  1.9, -1.8,
                 3.8,  3.7,  4.2,  3.6,  4.4,  4.0,  2.7,  4.4,  5.4,  4.1,
                -1.5, 10.7,  9.2,  6.3,  5.0,  4.2,  4.0
            ],
            china: [
                ...nullPad(10),
                11.9, 13.0, 10.3, 11.9, 23.1, 22.4, 13.1, 17.6, 25.4, 14.8,
                10.0, 15.6, 20.9, 28.2, 35.0, 26.1, 17.1, 11.5,  6.5,  6.3,
                10.6, 10.9, 10.0, 12.9, 17.7, 16.5, 17.0, 23.0, 18.2,  8.4,
                17.8, 18.0, 10.4, 10.2,  8.7,  7.0,  8.1, 11.1,  9.7,  7.3,
                 2.7, 13.4,  4.8,  4.6,  5.0,  4.8,  4.6
            ],
            euro: [
                12.5, 10.2,  9.4, 11.9,  7.0,  5.4,  8.3,  6.1,  7.2,  8.7,
                 6.5,  4.2,  3.4,  4.9,  5.0,  4.4,  5.3,  3.1,  5.2,  5.7,
                 8.5,  8.2,  6.4,  3.3,  5.0,  4.3,  3.8,  3.2,  3.9,  4.1,
                 4.8,  3.5,  2.8,  2.5,  3.9,  3.4,  5.2,  3.8,  0.5, -2.5,
                 2.8,  2.1,  0.5,  1.2,  2.2,  3.6,  2.9,  4.2,  3.5,  3.1,
                -4.8,  8.4,  8.3,  6.5,  3.0,  3.2,  3.1
            ],
            korea: [
                25.0, 22.0, 20.0, 28.0, 30.0, 25.0, 35.0, 32.0, 30.0, 25.0,
                23.2, 21.8, 14.2, 17.6, 14.8, 11.4, 14.4, 16.8, 18.7, 13.0,
                19.6, 20.4, 12.8, 12.6, 16.0, 16.7, 12.5,  9.6, -1.9, 10.9,
                10.5,  9.2, 11.4,  6.8,  8.8,  6.4,  7.3,  9.1,  5.9,  4.0,
                 9.7,  5.4,  3.4,  4.3,  4.4,  5.4,  5.3,  5.5,  3.4,  1.4,
                 0.7,  6.8,  3.9,  3.4,  5.5,  4.5,  4.3
            ]
        };

        // 4. Inflation Rate (CPI YoY %)
        const inflation_data = {
            japan: [
                 7.7,  6.1,  4.5, 11.7, 23.2, 11.8,  9.3,  8.1,  3.8,  3.6,
                 7.8,  4.9,  2.7,  1.9,  2.3,  2.0,  0.6,  0.1,  0.7,  2.3,
                 3.1,  3.3,  1.7,  1.3,  0.7, -0.1,  0.1,  1.7,  0.7, -0.3,
                -0.7, -0.7, -0.9, -0.3,  0.0, -0.3,  0.2,  0.0, 1.4, -1.3,
                -0.7, -0.3, -0.0,  0.4,  2.7,  0.8, -0.1,  0.5,  1.0,  0.5,
                -0.0, -0.2,  2.5,  3.3,  2.5,  2.0,  1.8
            ],
            us: [
                 5.8,  4.3,  3.3,  6.2, 11.1,  9.1,  5.7,  6.5,  7.6, 11.3,
                13.5, 10.3,  6.1,  3.2,  4.3,  3.6,  1.9,  3.6,  4.1,  4.8,
                 5.4,  4.2,  3.0,  3.0,  2.6,  2.8,  3.0,  2.3,  1.6,  2.2,
                 3.4,  2.8,  1.6,  2.3,  2.7,  3.4,  3.2,  2.8,  3.8, -0.4,
                 1.6,  3.2,  2.1,  1.5,  1.6,  0.1,  1.3,  2.1,  2.4,  1.8,
                 1.2,  4.7,  8.0,  4.1,  2.8,  2.3,  2.2
            ],
            china: [
                ...nullPad(10), 
                 6.0,  2.4,  1.9,  1.5,  2.8,  9.3,  6.5,  7.3, 18.8, 18.0,
                 3.1,  3.4,  6.4, 14.7, 24.1, 17.1,  8.3,  2.8, -0.8, -1.4,
                 0.4,  0.7, -0.8,  1.2,  3.9,  1.8,  1.5,  4.8,  5.9, -0.7,
                 3.3,  5.4,  2.6,  2.6,  2.0,  1.4,  2.0,  1.6,  2.1,  2.9,
                 2.5,  0.9,  2.0,  0.2,  0.4,  1.2,  1.5
            ],
            euro: [
                 5.1,  5.2,  5.7,  7.3, 10.2,  9.4,  7.9,  7.5,  5.6,  6.4,
                 8.6,  8.2,  6.6,  5.4,  4.6,  3.8,  2.2,  2.1,  2.2,  3.4,
                 3.8,  4.1,  3.5,  2.8,  2.4,  2.2,  1.9,  1.5,  1.2,  1.1,
                 2.1,  2.3,  2.2,  2.1,  2.1,  2.2,  2.2,  2.1,  3.3,  0.3,
                 1.6,  2.7,  2.5,  1.4,  0.4,  0.2,  0.2,  1.5,  1.8,  1.2,
                 0.3,  2.6,  8.4,  5.4,  2.4,  2.0,  1.9
            ],
            korea: [
                16.0, 13.5, 11.7,  3.2, 24.3, 25.3, 15.3, 10.1, 14.5, 18.3,
                28.7, 21.4,  7.2,  3.4,  2.3,  2.5,  2.8,  3.0,  7.1,  5.7,
                 8.6,  9.3,  6.2,  4.8,  6.3,  4.5,  4.9,  4.4,  7.5,  0.8,
                 2.3,  4.1,  2.8,  3.5,  3.6,  2.8,  2.2,  2.5,  4.7,  2.8,
                 2.9,  4.0,  2.2,  1.3,  1.3,  0.7,  1.0,  1.9,  1.5,  0.4,
                 0.5,  2.5,  5.1,  3.6,  2.6,  2.1,  2.0
            ]
        };

        // 5. Government Spending Growth (YoY %)
        const govspend_data = {
            japan: [
                18.2, 17.5, 22.1, 16.4, 25.5, 14.8, 12.1, 11.2,  9.8, 10.5,
                 8.5,  7.2,  5.1,  4.2,  4.8,  5.2,  6.1,  5.8,  6.2,  8.1,
                 7.5,  6.2,  4.8,  5.5,  3.2,  5.1,  4.2,  2.1,  5.8,  1.5,
                 2.0,  3.1,  2.5,  1.8,  1.2,  1.5,  0.8,  1.2,  3.5, 12.1,
                 2.5,  3.2,  2.1,  1.8,  2.2,  1.5,  1.2,  1.1,  1.0,  2.5,
                15.2,  1.5, -2.1, -1.5,  0.5,  1.0,  1.2
            ],
            us: [
                 8.5,  7.2,  9.1,  6.5, 12.2, 10.1,  7.5,  8.2,  7.8,  9.1,
                10.5,  8.2,  7.1,  6.5,  5.8,  7.2,  6.1,  5.5,  6.2,  7.1,
                 5.8,  4.2,  3.5,  3.8,  2.5,  3.1,  3.5,  2.8,  3.1,  4.2,
                 5.1,  6.2,  5.8,  6.5,  5.1,  6.2,  5.8,  5.2,  8.5, 10.1,
                 3.5,  2.1,  1.5,  1.2,  2.5,  3.1,  2.5,  2.1,  3.5,  4.2,
                18.5,  5.2, -3.1, -1.5,  2.5,  3.0,  3.2
            ],
            china: [
                ...nullPad(20),
                12.5, 14.2, 16.5, 18.2, 15.1, 16.2, 18.5, 17.2, 15.5, 14.2,
                18.5, 17.1, 15.2, 12.5, 14.1, 16.5, 15.2, 18.1, 22.5, 25.1,
                18.5, 15.2, 14.1, 12.5, 11.2, 10.5,  9.5,  8.5,  9.1, 10.5,
                12.5,  5.2,  6.1,  5.5,  4.5,  5.0,  4.8
            ],
            euro: [
                ...nullPad(20),
                 4.8,  3.5,  2.1,  1.5,  2.5,  3.1,  4.2,  3.5,  2.8, 12.5,
                15.1,  8.5,  7.2,  6.1,  5.5,  4.8,  3.5,  2.8,  2.1,  1.5,
                 1.2, 15.5,  8.5,  4.2,  3.1,  2.5,  2.1,  2.0,  1.5,  1.8,
                 2.1,  2.5,  3.1, 12.5,  4.2,  1.5,  2.5
            ],
            korea: [
                ...nullPad(20),
                15.5, 16.2, 14.1, 12.5, 14.1, 15.2, 12.5,  8.5, 12.5, 10.1,
                 8.5,  9.2,  8.1,  7.5,  8.2,  7.1,  8.5,  9.2, 10.5, 12.1,
                 6.5,  5.2,  4.8,  5.1,  4.5,  5.2,  4.8,  5.1,  6.5,  7.2,
                15.5,  8.2,  5.1,  4.5,  5.0,  4.8,  4.5
            ]
        };

        // 6. Government Debt Growth (YoY %)
        const debt_data = {
            japan: [
                 5.2, 12.1, 18.5, 15.2, 28.5, 35.1, 32.5, 28.1, 25.5, 20.1,
                18.5, 15.2, 14.1, 12.5, 10.1,  8.5,  7.2,  6.1,  5.5,  6.2,
                 8.5, 10.2, 12.5, 15.1, 14.2, 12.5, 10.1,  8.5, 12.5, 15.1,
                 8.5,  7.2,  6.1,  5.5,  6.2,  5.8,  4.5,  3.2,  4.1,  8.5,
                 5.2,  4.8,  4.1,  3.5,  4.2,  3.8,  3.1,  2.5,  2.8,  2.1,
                 8.5,  5.2,  3.1,  2.5,  2.1,  2.0,  1.8
            ],
            us: [
                 5.1,  6.2,  5.8,  4.5,  8.5, 12.1, 10.5,  8.2,  7.1,  6.5,
                 8.5, 10.2, 15.1, 18.5, 16.2, 15.1, 14.2, 12.5, 10.1,  8.5,
                10.2, 12.5, 11.1,  8.5,  6.2,  5.5,  4.8,  3.5,  2.1,  1.5,
                 2.5,  3.1,  5.8,  8.5, 10.1,  8.5,  7.2,  6.1, 15.5, 18.2,
                12.5, 10.1,  8.5,  7.2,  6.1,  5.5,  4.8,  4.1,  5.5,  6.2,
                18.5,  8.5,  6.2,  5.5,  6.1,  5.8,  5.5
            ],
            china: [
                ...nullPad(20),
                18.5, 15.2, 14.1, 12.5, 14.1, 15.2, 12.5, 14.1, 25.5, 28.1,
                18.5, 15.2, 14.1, 15.2, 16.1, 18.5, 20.1, 18.5, 15.2, 14.1,
                22.5, 18.5, 15.2, 14.1, 12.5, 11.2, 10.5, 12.1, 14.2, 15.1,
                16.5, 18.2, 12.1, 10.5,  8.2,  7.5,  7.0
            ],
            euro: [
                ...nullPad(20),
                 4.8,  3.5,  2.1,  1.5,  2.5,  3.1,  4.2,  3.5,  2.8, 12.5,
                15.1,  8.5,  7.2,  6.1,  5.5,  4.8,  3.5,  2.8,  2.1,  1.5,
                 1.2, 15.5,  8.5,  4.2,  3.1,  2.5,  2.1,  2.0,  1.5,  1.8,
                 2.1,  2.5,  3.1, 12.5,  4.2,  1.5,  2.5
            ],
            korea: [
                ...nullPad(20),
                15.5, 18.2, 12.5, 10.1,  8.5, 12.5, 10.1,  8.5, 12.5, 15.1,
                 8.5,  7.2,  6.1,  8.5, 10.1,  8.5,  7.2,  8.5, 10.1, 12.5,
                18.5, 15.2, 12.5, 10.1,  8.5,  7.2,  6.5,  8.2,  9.5, 10.1,
                14.2, 18.5, 12.1, 10.5,  9.2,  8.5,  8.0
            ]
        };

        // 7. Property Prices (BIS Residential Property Prices YoY %)
        const property_data = {
            japan: [
                10.0, 12.0, 15.0, 30.0, 10.0, -5.0,  2.0,  4.0,  5.0,  7.0,
                 8.0,  6.0,  5.0,  4.0,  3.0,  4.0,  8.0, 15.0, 25.0, 20.0,
                10.0, -5.0, -10.0, -8.0, -5.0, -4.0, -3.0, -2.0, -3.0, -4.0,
                -5.0, -4.0, -5.0, -4.0, -3.0, -2.0,  1.0,  2.0, -1.0, -5.0,
                -2.0, -1.0, -1.0,  1.0,  2.0,  2.5,  3.0,  2.5,  2.0,  2.0,
                 1.5,  4.5,  6.5,  4.0,  3.0,  2.0,  1.5
            ],
            us: [
                 5.0,  6.0,  7.5,  8.0,  9.0,  6.0,  7.0, 11.0, 14.0, 13.0,
                 8.0,  5.0,  1.0,  3.0,  4.0,  5.0,  6.0,  6.5,  7.0,  6.0,
                 2.0, -1.0,  0.5,  2.0,  3.0,  4.0,  4.5,  5.0,  6.0,  7.0,
                 8.0,  8.5,  9.0, 10.0, 12.0, 14.0,  8.0, -3.0, -10.0, -6.0,
                -2.0, -3.0,  3.0,  6.0,  5.0,  5.5,  6.0,  6.0,  5.0,  4.0,
                 8.0, 16.0, 14.0,  2.0,  4.0,  3.5,  3.0 
            ],
            china: [
                ...nullPad(30), 
                 4.0,  5.0, 10.0, 14.0,  8.0, 15.0,  2.0, 10.0, 15.0,  5.0,
                 2.0,  8.0, -2.0,  4.0, 12.0,  8.0,  6.0,  5.0,  4.0,  2.0,
                -3.0, -5.0, -6.0, -3.0, -1.0,  0.5,  1.0
            ],
            euro: [
                ...nullPad(20), 
                 2.0,  1.0,  1.5,  2.0,  3.0,  4.0,  5.0,  6.0,  7.0,  8.0,
                 9.0, 10.0,  9.0,  5.0, -1.0, -3.0, -1.0, -1.0, -2.0, -2.0,
                -1.0,  1.0,  3.0,  4.0,  4.5,  4.0,  5.0,  8.0,  7.0, -1.0,
                -2.0,  0.5,  1.5,  2.0,  2.5,  2.0,  1.8
            ],
            korea: [
                ...nullPad(16), 
                 5.0, 10.0, 20.0, 15.0, 20.0, -2.0, -5.0, -4.0, -1.0,  0.0,
                 1.0,  2.0, -12.0, -5.0, 2.0, 10.0, 15.0, 10.0, -2.0,  4.0,
                12.0,  5.0,  4.0,  1.0,  2.0,  6.0,  0.0,  1.0,  2.0,  4.0,
                 2.0,  1.0,  2.0, -1.0,  8.0, 15.0, -5.0, -10.0, -2.0, 1.0, 2.0
            ]
        };

        // 8. Velocity
        const velocity_data = {
            japan: [
                1.42, 1.40, 1.38, 1.39, 1.45, 1.42, 1.38, 1.35, 1.34, 1.32,
                1.33, 1.31, 1.28, 1.26, 1.25, 1.23, 1.20, 1.15, 1.12, 1.08,
                1.05, 1.06, 1.08, 1.05, 1.02, 0.99, 0.97, 0.95, 0.92, 0.90,
                0.88, 0.86, 0.85, 0.83, 0.82, 0.80, 0.79, 0.78, 0.76, 0.74,
                0.73, 0.71, 0.70, 0.69, 0.68, 0.67, 0.66, 0.65, 0.64, 0.63,
                0.58, 0.56, 0.55, 0.57, 0.58, 0.58, 0.59
            ],
            us: [
                1.75, 1.72, 1.74, 1.76, 1.80, 1.78, 1.75, 1.77, 1.80, 1.82,
                1.85, 1.88, 1.84, 1.81, 1.83, 1.85, 1.82, 1.84, 1.87, 1.90,
                1.93, 1.95, 1.98, 2.02, 2.05, 2.10, 2.12, 2.15, 2.11, 2.10,
                2.08, 2.02, 1.98, 1.95, 1.92, 1.95, 1.97, 1.99, 1.85, 1.75,
                1.71, 1.63, 1.58, 1.55, 1.53, 1.50, 1.45, 1.44, 1.46, 1.44,
                1.12, 1.14, 1.22, 1.35, 1.37, 1.40, 1.42
            ],
            china: [
                ...nullPad(20),
                1.55, 1.52, 1.45, 1.38, 1.30, 1.25, 1.20, 1.15, 1.10, 1.05,
                0.98, 0.92, 0.88, 0.85, 0.80, 0.75, 0.72, 0.70, 0.68, 0.65,
                0.62, 0.60, 0.58, 0.56, 0.54, 0.52, 0.50, 0.48, 0.47, 0.46,
                0.45, 0.44, 0.43, 0.42, 0.41, 0.40, 0.39
            ],
            euro: [
                ...nullPad(20),
                1.40, 1.35, 1.30, 1.25, 1.20, 1.25, 1.22, 1.18, 1.15, 1.12,
                1.10, 1.08, 1.05, 1.02, 1.00, 0.98, 0.95, 0.92, 0.90, 0.85,
                0.82, 0.80, 0.78, 0.77, 0.76, 0.75, 0.74, 0.73, 0.72, 0.71,
                0.65, 0.66, 0.68, 0.70, 0.71, 0.71, 0.71
            ],
            korea: [
                ...nullPad(20),
                1.60, 1.55, 1.50, 1.45, 1.40, 1.35, 1.30, 1.40, 1.35, 1.30,
                1.28, 1.25, 1.22, 1.20, 1.18, 1.15, 1.12, 1.10, 1.08, 1.05,
                1.02, 1.00, 0.98, 0.96, 0.94, 0.92, 0.90, 0.88, 0.86, 0.84,
                0.78, 0.76, 0.75, 0.74, 0.73, 0.73, 0.72
            ]
        };

        // Derived: Japan M2 Contribution
        const japan_contribution = years.map(year => {
            let total = 0, privateCont = 0, govtCont = 0;
            const idx = year - 1970;
            total = m2_data.japan[idx];

            if (year <= 1973) {
                privateCont = total * 0.95; govtCont = total * 0.05; 
            } else if (year <= 1979) {
                privateCont = total * 0.7; govtCont = total * 0.3;
            } else if (year <= 1989) {
                privateCont = total * 1.1; govtCont = total * -0.1; 
            } else if (year <= 1993) {
                privateCont = total * 0.2; govtCont = total * 0.8; 
            } else if (year <= 2005) {
                privateCont = -1.5; govtCont = total + 1.5; 
            } else if (year <= 2012) {
                privateCont = 0.5; govtCont = total - 0.5;
            } else if (year <= 2019) {
                privateCont = 1.8; govtCont = total - 1.8;
            } else if (year === 2020 || year === 2021) {
                privateCont = total * 0.5; govtCont = total * 0.5;
            } else {
                privateCont = total * 0.6; govtCont = total * 0.4;
            }
            return { year, total, private: privateCont, govt: govtCont };
        });

        // --- CUSTOM PLUGINS ---
        const customAnnotationsPlugin = {
            id: 'customAnnotations',
            afterDatasetsDraw(chart, args, options) {
                const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
                const labels = chart.data.labels;
                
                // 1. バブル崩壊 (1991年)
                const index1991 = labels.indexOf(1991);
                if (index1991 !== -1) {
                    const xPos = x.getPixelForValue(index1991);
                    ctx.save();
                    ctx.beginPath();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#ef4444'; 
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(xPos, top);
                    ctx.lineTo(xPos, bottom);
                    ctx.stroke();

                    const text = 'バブル崩壊';
                    ctx.font = 'bold 12px "Noto Sans JP", sans-serif';
                    const metrics = ctx.measureText(text);
                    const textWidth = metrics.width;
                    const textHeight = 20;
                    const padding = 6;
                    
                    const yPos = top + 10;
                    const rectX = xPos - (textWidth / 2) - padding;
                    const rectY = yPos;
                    const rectW = textWidth + (padding * 2);
                    const rectH = textHeight;

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fillRect(rectX, rectY, rectW, rectH);
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([]);
                    ctx.strokeRect(rectX, rectY, rectW, rectH);
                    ctx.fillStyle = '#dc2626';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, xPos, yPos + (rectH / 2));
                    ctx.restore();
                }

                // 2. 基準年 (累積成長モードの時のみ表示)
                if (currentDataFormat === 'index' && currentMode !== 'contribution' && currentMode !== 'velocity') {
                    const indexBase = labels.indexOf(currentBaseYear);
                    if (indexBase !== -1) {
                        const xPosBase = x.getPixelForValue(indexBase);
                        ctx.save();
                        ctx.beginPath();
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#000000'; // 黒色
                        ctx.setLineDash([5, 5]);
                        ctx.moveTo(xPosBase, top);
                        ctx.lineTo(xPosBase, bottom);
                        ctx.stroke();

                        const textBase = `基準年 (${currentBaseYear})`;
                        ctx.font = 'bold 12px "Noto Sans JP", sans-serif';
                        const metricsBase = ctx.measureText(textBase);
                        const textWidthBase = metricsBase.width;
                        const textHeightBase = 20;
                        const paddingBase = 6;
                        
                        const yPosBase = top + 40;
                        const rectXBase = xPosBase - (textWidthBase / 2) - paddingBase;
                        const rectYBase = yPosBase;
                        const rectWBase = textWidthBase + (paddingBase * 2);
                        const rectHBase = textHeightBase;

                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.fillRect(rectXBase, rectYBase, rectWBase, rectHBase);
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([]);
                        ctx.strokeRect(rectXBase, rectYBase, rectWBase, rectHBase);
                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(textBase, xPosBase, yPosBase + (rectHBase / 2));
                        ctx.restore();
                    }
                }
            }
        };

        // --- VIEW TEMPLATES ---
        const VIEWS = {
            contribution: {
                title: "日本の貨幣推移 (内訳寄与度)",
                subtitle: "マネーストック（M2）前年比増加率への寄与分解 (1970-2026年)",
                theory: `<strong>💡 貨幣発行のメカニズム</strong><br>
                         世の中の貨幣（銀行預金）は、誰かが銀行から<strong>「借入」</strong>を行うことで生まれ、<strong>「返済」</strong>することで消えてなくなります（信用創造）。<br>
                         このグラフは、過去の日本において、貨幣の量を増やしたのは<span class="highlight-private">「民間の借入（青）」</span>だったのか、<span class="highlight-govt">「政府の国債発行（赤）」</span>だったのかを積み上げ棒グラフで示しています。`,
                analysis: `<p><strong>1. 高度成長〜バブル期 (1970-1990): 民間主導の貨幣拡大</strong><br>
                           <span class="highlight-private">民間企業</span>の旺盛な資金需要が貨幣を生み出していました。特に1980年代後半のバブル期は、不動産や株への投機資金として民間向け貸出が爆発的に増え、政府が国債発行をする必要がない状態でした。</p>
                           <p><strong>2. バブル崩壊〜失われた30年 (1991-2012): 民間の「貨幣消滅」と政府の穴埋め</strong><br>
                           バブル崩壊後、民間企業は借金の返済を優先しました。借金の返済は「貨幣の消滅」を意味します。<br>
                           この穴を埋めたのが<span class="highlight-govt">政府の国債発行（財政赤字）</span>です。政府が国債を発行して支出することで、マネーストックの減少を防いでいた時期です。</p>
                           <p><strong>3. コロナ禍 (2020): 官民による同時拡大</strong><br>
                           緊急時の企業支援（民間貸出）と定額給付金（財政支出）が重なり、近年稀に見る急拡大が起きました。</p>`
            },
            money: {
                title: "マネーストック（M2/M3）の推移",
                subtitle: "主要国における通貨供給量の変動比較 (1970-2026年)",
                theory: `<strong>💡 マネーストックとは？</strong><br>
                         金融機関から経済全体に供給されている通貨の総量（現金通貨＋預金通貨など）です。<br>
                         通常、経済活動が活発になると資金需要が増えてマネーストックの伸び率は高まりますが、過剰な供給はインフレを引き起こします。`,
                analysis: `<p><strong>🇯🇵 日本：バブル崩壊後の長期停滞</strong><br>
                           1970年代の「狂乱物価」期には28.5%の伸びを記録しましたが、1990年のバブル崩壊以降は一転して急減。以降30年近く、低空飛行が続いています。</p>
                           <p><strong>🇺🇸 米国：コロナショックと歴史的収縮</strong><br>
                           2020年のパンデミック対策で、戦後最大級のM2増加（約25%）を記録しました。その反動で2022-23年には統計開始以来初の「マイナス成長」を記録しました。</p>`
            },
            loans: {
                title: "民間銀行による貸出金額の推移",
                subtitle: "民間部門への銀行信用（貸出）の前年比増加率 (1970-2026年)",
                theory: `<strong>💡 銀行貸出と信用創造</strong><br>
                         銀行が企業や家計に貸し出しを行うと、その瞬間に新たな預金（貨幣）が生まれます（信用創造）。つまり、民間貸出の伸びはマネーストック増加の最大の原動力であり、経済の活力を直接的に示す指標です。`,
                analysis: `<p><strong>🇯🇵 日本：バブル崩壊後の深刻な「借り控え」</strong><br>
                           1980年代までは10%前後の高い伸びを示し、経済に血液を供給していましたが、バブル崩壊後の1990年代後半から2000年代にかけては、企業が借金返済を優先したためマイナス成長が続きました。これが長引くデフレの根本原因です。</p>
                           <p><strong>🇺🇸 米国：金融危機による収縮</strong><br>
                           リーマンショック（2008年）後に激しい信用収縮（貸出減）が起きましたが、その後は順調に回復。コロナ禍では企業の資金確保で一時急増しました。</p>
                           <p><strong>🇨🇳 中国：爆発的融資による牽引</strong><br>
                           2000年代後半から2010年代にかけて、15%以上の猛烈なペースで貸出を増やし、インフラや不動産投資を支えました。現在は過剰債務の抑制により一桁台へと軟着陸を図っています。</p>`
            },
            inflation: {
                title: "インフレ率（CPI）の推移",
                subtitle: "消費者物価指数の変動 (1970-2026年)",
                theory: `<strong>💡 インフレ率とは？</strong><br>
                         消費者が購入するモノやサービスの価格が、前年と比べてどれくらい上がったか（下がったか）を示します。<br>
                         マネーストックの急増後や、原油価格高騰などの供給ショック時に大きく跳ね上がります。`,
                analysis: `<p><strong>🇯🇵 日本：狂乱物価からデフレ、そして再インフレへ</strong><br>
                           1973-74年の第一次オイルショック時にはインフレ率が24%に達しました。しかしバブル崩壊後の1990年代後半から2010年代にかけては、慢性的なマイナス（デフレ）に苦しみました。現在は再びプラス圏に浮上しています。</p>
                           <p><strong>🇺🇸 米国：グレートインフレーションとコロナ後のスパイク</strong><br>
                           1970年代から80年代初頭にかけての高インフレ期（最高13.5%）を経て安定していましたが、2022年に再び8%台に到達。中央銀行の強力な引き締めにより鎮静化へ向かっています。</p>`
            },
            nominal: {
                title: "名目GDPの推移",
                subtitle: "物価変動を含む経済規模の拡大ペース (1970-2026年)",
                theory: `<strong>💡 名目GDP成長率とは？</strong><br>
                         実際に市場で取引されている価格（時価）で評価したGDPの成長率です。インフレ（物価上昇）の時は実質GDPより高くなります。<br>
                         「経済の体感温度」や「税収の伸び」に近いのは実質よりも名目です。`,
                analysis: `<p><strong>🇯🇵 日本：デフレ脱却の兆し</strong><br>
                           1990年代後半から「名目成長率がほぼゼロ」という異常な状態が続きました。これはモノの値段が上がらない（デフレ）ため、売上金額が増えない状態を意味します。2023年以降、インフレの定着により名目成長率が実質を上回る形に戻りつつあります。</p>`
            },
            gdp: {
                title: "実質GDPの推移",
                subtitle: "物価変動を除いた真の経済成長力 (1970-2026年)",
                theory: `<strong>💡 実質GDP成長率とは？</strong><br>
                         名目GDPから物価変動の影響を取り除いた成長率です。生産量やサービスの提供量が実際にどれだけ増えたかを表しており、経済の実力を測る最も基本的な指標です。`,
                analysis: `<p><strong>🇯🇵 日本：安定成長への移行と停滞</strong><br>
                           1970年代前半までは10%近い高度経済成長でしたが、オイルショックを機に安定成長期へ移行。1990年以降は0〜1%台の低成長が定着しています。</p>
                           <p><strong>🇨🇳 中国：爆発的成長から中速成長へ</strong><br>
                           かつては年率10%を超える驚異的な成長を続けましたが、現在は4〜5%程度の「中速成長」へとシフトしています。</p>`
            },
            govspend: {
                title: "政府支出の推移",
                subtitle: "財政出動（一般政府総支出）の規模変動 (1970-2026年)",
                theory: `<strong>💡 政府支出の増加率とは？</strong><br>
                         政府が公共事業、社会保障、給付金などに使うお金が前年からどれだけ増えたかを示します。<br>
                         不況時やパンデミックなどの危機時には、民間経済を支えるために政府支出が急増します（ケインズ政策）。`,
                analysis: `<p><strong>🚨 コロナショック（2020年）の歴史的急増</strong><br>
                           2020年はすべての国で政府支出が急増しました。米国は約18%、日本も約15%という平時ではありえない規模の伸びを記録し、これが直後のインフレの一因となりました。</p>
                           <p><strong>🇯🇵 日本の90年代：公共事業による下支え</strong><br>
                           バブル崩壊後の1990年代後半、日本政府は巨額の公共事業等を行い、政府支出を継続的に増加させて経済の底割れを防ごうとしました。</p>`
            },
            debt: {
                title: "政府債務の推移",
                subtitle: "一般政府債務残高の拡大ペース (1970-2026年)",
                theory: `<strong>💡 国債増加率とは？</strong><br>
                         政府の負債（主に国債）の残高が前年から何%増えたかを示します。<br>
                         税収を上回る支出（財政赤字）を行うと、国債が発行され債務残高が増加します。国債発行は中央銀行や民間銀行を通じて新たな貨幣を生み出す主要なルートです。`,
                analysis: `<p><strong>🇯🇵 日本：特例公債とバブル後の急増</strong><br>
                           1970年代後半の特例公債（赤字国債）発行開始時や、1990年代後半〜2000年代にかけての金融危機対応時に急激な伸びを記録しました。これが現在に至る莫大な政府債務の蓄積プロセスです。</p>
                           <p><strong>🌍 世界的な危機時の借金依存</strong><br>
                           リーマンショック（2008-09年）とコロナショック（2020-21年）には、各国とも税収減と支出増に対応するため、国債を猛烈な勢い（10〜20%増）で発行しました。</p>`
            },
            property: {
                title: "不動産価格の推移",
                subtitle: "BIS 住宅価格統計 (Residential Property Prices) (1970-2026年)",
                theory: `<strong>💡 不動産価格と信用創造の密接な関係</strong><br>
                         不動産は銀行借入（住宅ローン、不動産投資ローン）の最大の担保です。<br>
                         不動産価格が上昇すると担保価値が上がり、銀行はより多くのお金を貸し出せるようになります（信用創造の拡大）。逆にバブルが崩壊して価格が下落すると、不良債権が発生し、銀行は貸し出しを渋るようになります（信用収縮）。`,
                analysis: `<p><strong>🇯🇵 日本：バブルの熱狂とその後の失われた30年</strong><br>
                           1980年代後半、地価は前年比20%超の高騰を見せ、強烈な信用創造を引き起こしました。しかし1991年のバブル崩壊以降、10年以上にわたってマイナスが続き、これが日本のマネーストック低迷とデフレの最大の要因となりました。</p>
                           <p><strong>🇺🇸 米国：サブプライムとコロナバブル</strong><br>
                           2000年代中盤の住宅バブルとその崩壊（リーマンショック）が鮮明に表れています。また、2020-2022年にはコロナ禍の低金利需要により再び歴史的な急騰（15%超）を記録しました。</p>
                           <p><strong>🇨🇳 中国：不動産神話の崩壊</strong><br>
                           長らく「不動産価格は下がらない」という神話のもと中国経済を牽引してきましたが、近年の政府の規制（三道紅線）や恒大集団などの危機により、明確な下落トレンド（不動産不況）に入っています。</p>`
            },
            velocity: {
                title: "貨幣流通速度 (Velocity) の推移",
                subtitle: "名目GDP ÷ マネーストック (M2) (1970-2026年)",
                theory: `<strong>💡 貨幣流通速度とは？</strong><br>
                         お金が1年間に何回使われたか（回転したか）を示す指標です。計算式は「名目GDP ÷ マネーストック」。<br>
                         この値が低下するということは、世の中にお金は増えているのに、それが決済や消費に使われず、預金として眠っている（退蔵されている）ことを意味します。`,
                analysis: `<p><strong>🌏 全体傾向：経済の金融化</strong><br>
                           世界的に低下傾向が見られます。これは実体経済（GDP）の成長スピード以上に、金融資産（マネーストック）の膨張スピードが速い「経済の金融化」が世界的に進行していることを示しています。</p>`
            }
        };

        // --- RENDER LOGIC ---
        let myChart = null;

        function renderView(mode) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            const tmpl = VIEWS[mode];
            const showControls = !['contribution', 'velocity'].includes(mode);

            let controlsHtml = '';
            if (showControls) {
                controlsHtml = `
                    <div class="controls-bar" id="data-controls">
                        <div class="toggle-group">
                            <input type="radio" id="fmt-yoy" name="format" value="yoy" ${currentDataFormat === 'yoy' ? 'checked' : ''}>
                            <label for="fmt-yoy">前年比 (%)</label>
                            <input type="radio" id="fmt-index" name="format" value="index" ${currentDataFormat === 'index' ? 'checked' : ''}>
                            <label for="fmt-index">累積成長 (指数)</label>
                        </div>
                        <div class="base-year-select" id="base-year-container" style="display: ${currentDataFormat === 'index' ? 'flex' : 'none'};">
                            <label for="base-year">基準年 (100) :</label>
                            <select id="base-year">
                                ${years.map(y => `<option value="${y}" ${y === currentBaseYear ? 'selected' : ''}>${y}年</option>`).join('')}
                            </select>
                            <span style="font-size: 0.7rem; color: #64748b; font-weight: normal; margin-left: 8px;">※グラフの点をクリックしても変更可能</span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('content-area').innerHTML = `
                <div class="main-card">
                    <h2 class="report-title">${tmpl.title}</h2>
                    <p class="report-subtitle">${tmpl.subtitle}</p>
                    <div class="theory-box">${tmpl.theory}</div>
                    
                    ${controlsHtml}
                    
                    <div class="chart-wrapper">
                        <div id="custom-legend" class="draggable-legend"></div>
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div class="analysis">
                        <h3>📈 詳細分析レポート</h3>
                        ${tmpl.analysis}
                    </div>
                    <div class="chart-footer">
                        ※ 出所：World Bank, FRED, IMF WEO (2025 Oct), BIS, 各国中央銀行統計<br>
                        ※ 直近2年程度はIMF等による推計・予測値を含みます。<br>
                        ※ 日本の寄与度は日銀「マネタリーサーベイ」等に基づく推計です。<br>
                        ※ 一部古いデータが存在しない国・期間はチャートが非表示となります。
                    </div>
                </div>
            `;

            if (showControls) {
                document.querySelectorAll('input[name="format"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        currentDataFormat = e.target.value;
                        document.getElementById('base-year-container').style.display = currentDataFormat === 'index' ? 'flex' : 'none';
                        renderChart(currentMode);
                    });
                });
                document.getElementById('base-year').addEventListener('change', (e) => {
                    currentBaseYear = parseInt(e.target.value, 10);
                    if (currentDataFormat === 'index') {
                        renderChart(currentMode);
                    }
                });
            }

            renderChart(mode);
        }

        function generateHtmlLegend(chart, mode) {
            const legendContainer = document.getElementById('custom-legend');
            legendContainer.innerHTML = '';
            
            const title = document.createElement('div');
            title.className = 'legend-title';
            title.innerText = '凡例 (クリックで切替 / ドラッグで移動)';
            legendContainer.appendChild(title);

            // Safer extraction of dataset properties to avoid plugin dependency errors
            const items = chart.data.datasets.map((dataset, i) => {
                return {
                    text: dataset.label,
                    fillStyle: dataset.backgroundColor || dataset.borderColor,
                    strokeStyle: dataset.borderColor,
                    lineWidth: dataset.borderWidth || 1,
                    hidden: !chart.isDatasetVisible(i),
                    datasetIndex: i
                };
            });

            items.forEach(item => {
                const li = document.createElement('div');
                li.className = 'legend-item';
                if (item.hidden) li.classList.add('hidden-dataset');
                
                li.onclick = () => {
                    const isVisible = chart.isDatasetVisible(item.datasetIndex);
                    chart.setDatasetVisibility(item.datasetIndex, !isVisible);
                    chart.update();
                    
                    const dataset = chart.data.datasets[item.datasetIndex];
                    if (dataset.customId) {
                        countryVisibility[dataset.customId] = !isVisible;
                    }

                    generateHtmlLegend(chart, mode); 
                };

                const box = document.createElement('div');
                box.className = 'legend-box';
                box.style.backgroundColor = item.fillStyle;
                box.style.borderColor = item.strokeStyle;
                box.style.borderWidth = item.lineWidth + 'px';

                const text = document.createElement('div');
                text.className = 'legend-text';
                text.innerText = item.text;

                li.appendChild(box);
                li.appendChild(text);
                legendContainer.appendChild(li);
            });
            makeElementDraggable(legendContainer);
        }

        function makeElementDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                e = e || window.event; e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                elmnt.style.cursor = 'grabbing';
            }
            function elementDrag(e) {
                e = e || window.event; e.preventDefault();
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                elmnt.style.right = 'auto'; elmnt.style.bottom = 'auto';
            }
            function closeDragElement() {
                document.onmouseup = null; document.onmousemove = null;
                elmnt.style.cursor = 'move';
            }
        }

        function renderChart(mode) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();

            // 1. Contribution Graph (Stacked Bar)
            if (mode === 'contribution') {
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: '政府部門寄与 (国債発行等)',
                                data: japan_contribution.map(d => d.govt),
                                backgroundColor: '#dc2626', borderColor: '#dc2626',
                                stack: 'Stack 0', order: 1
                            },
                            {
                                label: '民間部門寄与 (貸出等)',
                                data: japan_contribution.map(d => d.private),
                                backgroundColor: '#2563eb', borderColor: '#2563eb',
                                stack: 'Stack 0', order: 2
                            },
                            {
                                label: 'M2総増加率',
                                data: japan_contribution.map(d => d.total),
                                type: 'line',
                                borderColor: '#000000', borderWidth: 4,
                                pointRadius: 0, pointHoverRadius: 4, tension: 0.3, order: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { maxTicksLimit: 12 } },
                            y: { stacked: true, title: { display: true, text: '前年比寄与度 (%)' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    footer: (items) => {
                                        const barSum = items.filter(i => i.dataset.type !== 'line').reduce((a, b) => a + b.raw, 0);
                                        return '合計: ' + barSum.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    },
                    plugins: [customAnnotationsPlugin]
                });
                generateHtmlLegend(myChart, mode);
                return;
            }

            // 2. Select Base Dataset
            let baseDataset;
            switch(mode) {
                case 'money': baseDataset = m2_data; break;
                case 'loans': baseDataset = loans_data; break;
                case 'inflation': baseDataset = inflation_data; break;
                case 'nominal': baseDataset = nominal_data; break;
                case 'gdp': baseDataset = gdp_data; break;
                case 'govspend': baseDataset = govspend_data; break;
                case 'debt': baseDataset = debt_data; break;
                case 'property': baseDataset = property_data; break;
                case 'velocity': baseDataset = velocity_data; break;
            }

            // 3. Apply Index Transformation if needed
            let displayDataset = {};
            let yLabel = '';
            let formatStr = v => v.toFixed(1) + '%';
            const isVelocity = mode === 'velocity';
            const isIndexMode = currentDataFormat === 'index' && !isVelocity;

            if (isVelocity) {
                displayDataset = baseDataset;
                yLabel = '回転率 (回/年)';
                formatStr = v => v.toFixed(2);
            } else if (isIndexMode) {
                for (const key in baseDataset) {
                    displayDataset[key] = calculateIndexData(baseDataset[key], currentBaseYear);
                }
                yLabel = `累積指数 (${currentBaseYear}年=100)`;
                formatStr = v => v.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1});
            } else {
                displayDataset = baseDataset;
                yLabel = '前年比 (%)';
            }

            // 4. Prepare Chart Data Array (hidden状態を反映)
            const ds = [
                { customId: 'japan', label: '🇯🇵 日本', data: displayDataset.japan, borderColor: '#000000', borderWidth: 4, pointRadius: 0, order: 0, spanGaps: true, hidden: !countryVisibility.japan },
                { customId: 'us', label: '🇺🇸 米国', data: displayDataset.us, borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, order: 2, spanGaps: true, hidden: !countryVisibility.us },
                { customId: 'china', label: '🇨🇳 中国', data: displayDataset.china, borderColor: '#ef4444', borderWidth: 2, pointRadius: 0, order: 3, spanGaps: true, hidden: !countryVisibility.china },
                { customId: 'euro', label: '🇪🇺 ユーロ圏', data: displayDataset.euro, borderColor: '#f59e0b', borderWidth: 1.5, pointRadius: 0, borderDash: [5,5], order: 4, spanGaps: true, hidden: !countryVisibility.euro },
                { customId: 'korea', label: '🇰🇷 韓国', data: displayDataset.korea, borderColor: '#10b981', borderWidth: 1.5, pointRadius: 0, order: 5, spanGaps: true, hidden: !countryVisibility.korea }
            ];

            // 5. Append Average to label based on raw YoY data
            if (!isVelocity && currentDataFormat !== 'index') {
                ds.forEach(d => {
                    const countryKey = d.label.split(' ')[1] === '日本' ? 'japan' :
                                       d.label.split(' ')[1] === '米国' ? 'us' :
                                       d.label.split(' ')[1] === '中国' ? 'china' :
                                       d.label.split(' ')[1] === 'ユーロ圏' ? 'euro' : 'korea';
                    const avg = getAvg90(baseDataset[countryKey]);
                    d.label = `${d.label} (Avg '90+: ${avg}%)`;
                });
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets: ds },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    onClick: (e, activeElements) => {
                        if (currentDataFormat === 'index' && activeElements.length > 0) {
                            const dataIndex = activeElements[0].index;
                            currentBaseYear = years[dataIndex];
                            
                            const selectEl = document.getElementById('base-year');
                            if (selectEl) selectEl.value = currentBaseYear;
                            
                            setTimeout(() => {
                                renderChart(currentMode);
                            }, 0);
                        }
                    },
                    onHover: (e, activeElements) => {
                        if (currentDataFormat === 'index') {
                            e.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    if (ctx.raw === null) return null;
                                    const baseLabel = ctx.dataset.label.split(' (')[0];
                                    return `${baseLabel}: ${formatStr(ctx.raw)}`;
                                }
                            },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)', titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e2e8f0', borderWidth: 1, padding: 10
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 12 } },
                        y: { title: { display: true, text: yLabel }, border: { dash: [4, 4] }, grid: { color: '#f1f5f9' } }
                    }
                },
                plugins: [customAnnotationsPlugin]
            });

            generateHtmlLegend(myChart, mode);
        }

        // Initialize (Default View)
        renderView('contribution');
    </script>
</body>
</html>
